<!DOCTYPE html>
<html lang="en">
    <head>
        <script type="text/javascript" src="../../loadCSS.js"></script>
        <script>
            // const sqlite3 = require('sqlite3').verbose();
            // const db = new sqlite3.Database('ssDB');
            //const $ = require("jquery");

            window.$ = window.jQuery = require('../../node_modules/jquery/dist/jquery.min.js');
            require('../../assets/js/moment.min.js')
            require('../../assets/js/libs/bootstrap-table/dist/bootstrap-table.min.js')
            require('../../assets/js/libs/bootstrap-table/dist/extensions/filter-control/bootstrap-table-filter-control.min.js')
            require('../../assets/js/libs/bootstrap-table/src/extensions/editable/bootstrap-table-editable.js')
        </script>
        <script src="../../dist/bundle.js"></script>
        <style type="text/css">
        
        div.bootstrap-table {
			border-radius: 4px;
            background:transparent;
            padding-top:0px;
		}

		.fixed-table-toolbar .search{
            background-color:transparent;
		}

		.fixed-table-container{
			padding-top:0px;
		}

		.fixed-table-toolbar{
            background-color:transparent;
            margin-bottom:0px;
        }

        .fixed-table-loading{
		    display: none;
        }
    
        .fixed-table-toolbar{
            display: none;
        }
        
        .bootstrap-table .table thead > tr > th {
                background: #fff;
				border:none;
				font-size: 14px;
				font-weight: bold;
				color: #171717;
				border-bottom: solid 2px #dcdcdc;
        }

		.rowStyle{
			background-color: #ffffff;
			font-size: 14px;
			font-weight: 500;
			color: #565656;
        }
        
        .table > tbody > tr > td {
            padding: 10px 20px 10px 8px;
        }

        /* #content{
            width: calc(85% - 40px);
            position: relative;
            right: 0;
            margin: 0 auto ;
        } */

        html{
            background: #eff1f3;
        }

        input[type=number]::-webkit-inner-spin-button, 
		input[type=number]::-webkit-outer-spin-button { 
			-webkit-appearance: none; 
			margin: 0; 
		}

        .customModal{
            margin:auto;
            width: 800px;
            margin-top: 10%;
        }

        .customModalTwo{
            margin: auto;
            width: 600px;
            margin-top:10%;
        }

        .modal-open .modal{
            overflow-y: hidden;
        }

		</style>

    </head>
    <body class="menubar-hoverable header-fixed menubar-pin menubar-first" onload="loadPIList()">

        <div class='headerDiv' w3-include-html="../header.html"></div>

        <div id="base" style="background-color:#eff1f3;height:100%">
            <div id="sidebar" w3-include-html="../sidebar.html"></div>
            <div id="content">
                <!--Success Modal -->
                <div id="successModal" class="modal fade" role="dialog">
                    <div class="modal-dialog customModal" style="display:flex; justify-content:center">
                        <div class="modal-content" style="padding: 5%;border-radius: 8px;">
                            <div class="flex-row" style="justify-content: center;margin-top: 20px;margin-bottom: 10px">
                                <img src = "../../assets/img/sucess-icon.png">
                            </div>
                            <div class="flex-column" style="align-items: center;">
                                <span class="text_20_500_212b36"><span id="successTag"></span> Successful</span>
                                <span class="text_14_500_6b7783">
                                    <span class="fileName"></span> has been <span id="successTagl"></span> successfully
                                </span>
                                <span class="margin-10 text_14_500_1766a6" id="fileLocation">
                                </span>
                            </div>
                            <div class="flex-row" style="justify-content: center;margin-bottom: 20px">
                                <button class="btnWhite"  data-target="successModal" onclick="closeModal(this)">Close</button>
                            </div>
                        </div>

                    </div>
                </div>
                <!--END of Success Modal -->
                <div id="basepackModal" class="modal fade" role="dialog">
                    <div class="modal-dialog customModal">
                        <div class="modal-content" style="width:800px;border-radius: 8px;">
                            <div>
                                <div class="flex-row" style="padding: 24px 40px; border-bottom: solid 1px #979797;justify-content: space-between">
                                    <span class="text_18_500_212b36">Basepack</span>
                                    <button class="btn btn-md-secondary btnBlue"  onclick="triggerDownloadPdf()" style="margin-left: 10px">Download PDF</button>
                                </div>

                                <div id="basepack" style="padding:20px 40px 0px 40px;">
                                </div>

                                <div class="flex-row" style="justify-content: flex-end; padding:0px 40px 20px 40px;">
                                    <button class='longBtnBlue' data-target="basepackModal" onclick="closeModal(this)">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="basepackModalTwo" class="modal fade" role="dialog">
                    <div class="modal-dialog customModal" style="margin-top: 80px;">
                        <div class="modal-content" style="width:800px; border-radius: 8px;">
                            <div>
                                <div class="flex-row" style="padding: 24px 40px; background-color: #1766a6; border-bottom: solid 1px #979797;justify-content: space-between">
                                    <span class="text_18_500_fff">Non Allocated Stock Lines</span>
                                    <button class="whiteBtn" data-dismiss="modal" onclick="triggerPrintPdfTwo()">Download PDF</button>
                                </div>

                                <div id="basepackTwo" style="padding:20px; overflow: auto; height:500px;">
                                </div>

                                <div class="flex-row" style=" justify-content: center; background-color: lightgray; height:80px; margin: 0px 10px 10px 10px; border-radius: 4px;">
                                    <!-- <button class='longBtnWhite' onclick="reload()">Allocate Again</button> -->
                                    <button class='longBtnBlue' data-target="basepackModalTwo" onclick="closeModal(this)">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="productModal" class="modal fade" role="dialog">
                    <div class="modal-dialog customModal" style="margin-top:80px">
                        <div class="modal-content" style="border-radius: 8px;">
                            <div>
                                <div class="flex-row" style="padding: 24px 40px; background-color: #1766a6; border-radius: 4px; border-bottom: solid 1px #979797;justify-content: space-between">
                                    <span class="text_18_500_fff">Summary</span>
                                </div>

                                <div id="productDetails" style="padding:20px; overflow: auto; height:600px;">
                                </div>

                                <div class="flex-row" style=" justify-content: center; background-color: lightgray; height:80px; margin: 0px 10px 10px 10px; border-radius: 4px;">
                                    <button class='longBtnBlue' data-target="productModal" onclick="closeModal(this)">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="productModalTwo" class="modal fade" role="dialog">
                    <div class="modal-dialog customModal" style="margin-top:80px">
                        <div class="modal-content" style="border-radius: 8px;">
                            <div>
                                <div class="flex-row" style="padding: 24px 40px; background-color: #1766a6; border-radius: 4px; border-bottom: solid 1px #979797;justify-content: space-between">
                                    <span class="text_18_500_fff">Summary</span>
                                </div>

                                <div id="finalProductDetails" style="padding:20px; overflow: auto; height:600px;">
                                </div>

                                <div class="flex-row" style=" justify-content: center; background-color: lightgray; height:80px; margin: 0px 10px 10px 10px; border-radius: 4px;">
                                    <button class='longBtnBlue' data-target="productModalTwo" onclick="closeModal(this)">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="generateBill" class="modal fade" role="dialog">
                    <div class="modal-dialog customModalTwo">
                        <div class="modal-content" style="border-radius: 8px;">
                            <div style="padding:30px;">
                                <div class="flex-row" style="justify-content: center;margin-top: 20px;margin-bottom: 10px">
									<img src = "../../assets/img/sucess-icon.png">
                                </div>
                                
                                <div class="flex-row" style="justify-content: center;";>
                                    <span class="text_18_500_212b36">Your orders have been processed successfully</span>
                                </div>
                                <div class="flex-row" style="margin-top:30px; justify-content: space-between;">
                                    <button class='btnWhite' onclick="goBack()" >Close</button>
                                    <div class="flex-row">
                                        <button class="btnBlue flex-row"  onclick="triggerPrintPdf('print')" style="margin-left: 10px"><img  src="../../assets/img/print.png" style="padding: 0px 12px 5px 0">Print</button>
                                        <button class="btnBlue flex-row"  onclick="triggerPrintPdf()" style="margin-left: 10px"><img  src="../../assets/img/download.png" style="padding: 0px 12px 5px 0">Download</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="deleteModal" class="modal fade" role="dialog">
                    <div class="modal-dialog customModalTwo">
                        <div class="modal-content" style="padding:30px; border-radius: 8px;">
                            <div class="flex-column" style="align-items:center">
                                <span class="text_18_500_212b36">Are you sure you want to delete this item?</span>
                                <div class="flex-row" style="margin-top: 10px;">
                                    <button class='longBtnWhite' data-target="deleteModal" onclick="closeModal(this)">No</button>
                                    <button style="margin-left:10px;" class='longBtnBlue' onclick="finalDelete()">Yes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="deleteOrderModal" class="modal fade" role="dialog">
                    <div class="modal-dialog customModalTwo">
                        <div class="modal-content" style="padding:30px; border-radius: 8px;">
                            <div class="flex-column" style="align-items:center">
                                <span class="text_18_500_212b36">Are you sure you want to delete this market order?</span>
                                <div class="flex-row" style="margin-top: 10px;">
                                    <button class='longBtnWhite' data-target="deleteOrderModal" onclick="closeModal(this)">No</button>
                                    <button style="margin-left:10px;" class='longBtnBlue' onclick="finalDeleteOrder()">Yes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <section id="pendingOrdersSection">

                    <div class="section-body"> 

                    <div style="display:flex;flex-direction: row;justify-content: space-between; margin-top:60px;">
                        <div class="flex-row" onclick="goBack()" style="cursor: pointer;">
                            <span><img src="../../assets/img/back_icon.png"  style='width:8px;height:12px;'/></span>
                            <span style="margin-left: 10px;" class="text_18_500_565656">Outlet Billing and Returns</span>
                        </div>                        
                        <button class="btnBlue" onclick="stockAllocation()">Allocate Stock</button>
					</div>
                    
                    <div>
                        <span class="text_24_500_212b36">Pending Outlet Orders - </span>
                        <span style="padding-left: 20px;" class="text_24_500_6b7783" id="pendingPICount"></span>
                    </div>
                    
                    <div class="flex-row">
                        <input type="checkbox" id="selectAll" onclick="selectAll()" style="margin-top: 0px;"></input>
                        <span style="padding-left: 10px;" class="text_16_500_565656">Select All</span>
                    </div>

                    <div style="margin-top:10px; margin-bottom: 40px; display:flex; flex-direction:row;">
                        
                        <div style="display:flex; flex-direction:column; background:#fff; width:30%; border-radius:4px;">
                            
                            <div style="padding:16px 0px 16px 10px; border-bottom:solid 1px #dcdcdc"> 
                                <span class="text_18_500_212b36">Pending Outlet Orders</span>
                            </div>
                            
                            <div style="display:flex; flex-direction:column;" id="outletList">
                                
                                <!-- <div style="padding:10px; border-bottom:solid 1px #eff1f3">
                                    <div style="display:flex; flex-direction:row; align-items:center">
                                        <input type="checkbox"/>
                                        <span style="margin-left:10px" class="text_14_500_212b36">StoreName</span>
                                    </div>
                                    <div style="display:flex; flex-direction:row; justify-content:space-between;">
                                        <span style="margin-left:20px" class="text_14_500_565656">Total Items : 5</span><span class="text_18_500_212b36">&#8377; GrossBill</span>
                                    </div>
                                </div> -->
                           
                            </div>

                            <div style="height:40px">
                            </div>

                        </div>

                        <div id="orderDetailSection" style="display:none; background:#fff;margin-left:4px;">
                            <div style="background:#ddddddab; height:90px; padding:20px; display:flex; flex-direction:column;">
                                <div style="display:flex; flex-direction:row; justify-content:space-between">
                                    <span class="text_18_500_212b36"><span id="headerStore"></span></span>
                                    <span class="text_18_500_212b36">&#8377; <span id="headerPrice"></span></span>
                                </div>
                                <div style="display:flex; flex-direction:row; justify-content:flex-end">
                                    <span class="text_16_500_565656">Total Items : <span id="headerItems"></span></span>
                                </div>
                            </div>
                            <table class="table bulk_action dataTable no-footer" data-row-style="rowStyle" id="orderDetail">
                                <thead>
                                    <tr>
                                        <th data-field = "productName" data-sortable = "true">Name</th>
                                        <th data-field= "brandName" data-sortable="true">Brand</th>
                                        <th data-field= "unitsPerCase" data-sortable="true">Units Per Case</th>
                                        <th data-field= "closingStock" data-sortable="true">Closing Stock</th>
                                        <th data-field = "quantityOrdered" data-sortable = "true">Units</th> 
                                        <th data-field = "itemSales" data-sortable = "true">Value</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                        
                    </div>

                    <div id="totalSection" style="margin-top:10px; margin-bottom:40px; background:#fff; padding:20px; display:none; flex-direction:row; justify-content:space-between; border-radius:4px; ">
                        <span class="text_20_500_212b36">Total Selected Items</span>
                        <div style="display:flex; flex-direction:column; ">
                            <span class="text_16_500_565656">Total Stock Items : <span class="text_16_500_212b36" id="totalStockItems"></span></span>
                            <span class="text_16_500_565656">Total Stock Value : <span class="text_16_500_212b36">&#8377; </span><span class="text_16_500_212b36" id="totalStockValue"></span></span>
                        </div>
                    </div>
                    </div>
                </section>

                <section id="confirmationSection" style="display: none;"> 
                    <div class="section-body">
                        <div style="margin-top:60px; justify-content: space-between;" class="flex-row">
                            <span class="text_24_500_212b36">Confirm Outlet Orders</span>

                            <div class="flex-row">
                                <button class="btnWhite" onclick="reload()">Allocate Again</button>
                                <button class="btnBlue" style="margin-left: 10px;" onclick="confirm()">Confirm</button>
                            </div>
                        </div>

                        <div style="margin-top: 30px; display: flex; flex-direction: row;">
                            
                            <div style="display:flex; flex-direction:column; background:#fff; width:30%; border-radius:4px;">
                                <div style="padding:16px 0px 16px 10px; border-bottom:solid 1px #dcdcdc"> 
                                    <span class="text_18_500_212b36">Chosen Orders</span>
                                </div>
                                
                                <div style="display:flex; flex-direction:column;" id="chosenOutletList">
                                    
                                </div>
                            </div>

                            <div id="chosenOrderDetailSection" style="background:#fff;margin-left:4px;">
                                <div id="confirmationTables">

                                </div>                               
                            </div>

                        </div>
                        
                    </div>
                </section>

                <section id="finalView" style="display: none;"> 
                    <div class="section-body" style="flex:1">
                        <div style="margin-top:60px; justify-content: space-between;" class="flex-row">
                            <div class="flex-row" onclick="assignAgain()" style="cursor: pointer;">
                                <span><img src="../../assets/img/back_icon.png"  style='width:8px;height:12px;'/></span>
                                <span style="margin-left: 10px;" class="text_18_500_565656">Pending Outlet Orders</span>
                            </div>

                            <button class="btnBlue" onclick="productLevelData()">Basepack Summary</button>
                            <!-- <button class="btnBlue" onclick="viewDetails()">View Details</button> -->
                        </div>

                        <div>
                            <span class="text_24_500_212b36">Confirm Outlet Orders</span>
                        </div>

                        <div id="finalOrders" style="background: #fff; border-radius: 4px; margin:40px 0px; border:solid 1px #979797; padding-bottom: 60px;">
                            
                        </div>

                        <div class="flex-row" style="justify-content: space-between; align-items: flex-start; margin-bottom: 60px;">
                            <div class="flex-column" style="width:300px; border-radius: 4px; background-color: #fff; padding:20px; border:solid 1px #eff1f3">
                                <span class="text_18_500_212b36">Summary</span>

                                <div class="flex-row" style="margin-top:10px;">
                                    <span class="text_16_500_565656">Total Units - </span>
                                    <span class="text_16_500_212b36" style="padding-left: 10px;" id="totalQuantityOrdered"></span>
                                </div>
                                <div class="flex-row">
                                    <span class="text_16_500_565656">Total Value - </span>
                                    <span class="text_16_500_212b36" style="padding-left: 10px;" id="totalGrossSale"></span>
                                </div>
                                <div class="flex-row">
                                    <span class="text_16_500_565656">Total Discount Value - </span>
                                    <span class="text_16_500_212b36" style="padding-left: 10px;" id="totalDiscount"></span>
                                </div>
                            </div>

                            <div>
                                <button style="margin-top:0px;" id="bill" class="btnBlue" onclick="generateBill()">Generate Bill</button>
                            </div>
                        </div>
                        
                    </div>
                </section>

                <section id="noOrdersSection" style="display: none;">

                    <div style="margin-top:60px;">
                        <div class="flex-row" onclick="goBack()" style="cursor: pointer;">
                            <span><img src="../../assets/img/back_icon.png"  style='width:8px;height:12px;'/></span>
                            <span style="margin-left: 10px;" class="text_18_500_565656">Outlet Billing and Returns</span>
                        </div>        
                        <div style="margin-top:10px;">
                            <span class="text_24_500_212b36">No Pending Orders</span>
                        </div>                
					</div>

                    <!-- <div style="margin-top:20%; width:100%; justify-content: center;" class="flex-row">
                        <span class="text_24_500_212b36">No Pending Orders</span>
                    </div> -->
                </section>

            </div>
                  
        </div>

        <script type="text/javascript" src="../../helpers.js"></script>
        <script type="text/javascript" src="../../loadJS.js"></script>

        <script type="text/javascript">

            const { dialog } = require('electron').remote;
            // const ipc = require('electron').ipcRenderer;

            var outletList = [],proformaArray=[],PIDetail = [],stockProducts = [],allProductsList = [],batchVariant=[],cart=[];
            var totalStockValue = 0,batches,taxList,userID,userName,mocs,account,accountId = 2;;
            var deleteID,deleteOrderID,selectedOrders = 0;

            var loginResponse = JSON.parse(localStorage.getItem('loginResponse'));
            var deviceID = localStorage.getItem('deviceID');
            var store = loginResponse.storeList[0];
            var statements = [], finalOrders = [], childBatches = [];
            var discountProductList = [];
            var discountAppliedIDs = [];
            var discountLevelList = [];
            var discountClusters = [];
            var discountDetails = [];
            var nonAllocatedProducts = [];
            var details = [];
            var currentExOrderID = 0;
            var activePI = {pi:'',show:false};
            var payableAmnt = 0;
            var creditNotesAdjust = 0;
            var orderID;
            var orderTime;
            var rounding = 0;
            var grossSaleRounded = 0;
            var totalDiscountPrice = 0;
            var customerData ;
            var nonAllocatedDataArray = []
            var totalCashDiscount = 0
            var cashDiscPercent = 0
            var pdfTableData= []
            var creditNotesDetailsForPDF = []
            var noPrint = true

            var fetchingErrMsg='Error in fetching data!'
            var reRenderLocation='billingDashboard.html'

            $(document).ready(async()=>{
                await getMenu('Pending Outlet Orders')
                await backNavigation()
            })

            backNavigation=()=>{
                $('#imgForward').css('opacity',0.5)
                $('#imgBack').css({'opacity':1 , 'cursor' : 'pointer'}).click(()=>{
                    window.location.href=reRenderLocation
                })
            }


            function productLevelData(){

                var products = [];

                for(let pi in finalOrders)
                {
                    var missingProductsList = finalOrders[pi].missingProductsList;

                    for(let i=0;i<missingProductsList.length;i++)
                    {
                        var found = false;
                        var productID = missingProductsList[i].productID;

                        for(let j=0;j<products.length;j++)
                        {
                            if(productID == products[j].productID){  

                                products[j].quantityAssigned += missingProductsList[i].quantityAssigned;
                                products[j].quantityOrdered += missingProductsList[i].quantityOrdered;
                                
                                found = true;
                                break;
                            }
                        }

                        if(!found){
                            products.push(missingProductsList[i])
                        }
                    }
                }

                console.log(products)

                $('#finalProductDetails').empty();
                
                $('#finalProductDetails').append(`<div class="flex-row" style="padding-left:10px; height:60px;">
                                <div style="flex:3"><span class="text_16_500_212b36">Product Name</span></div>
                                <div style="flex:1;"><span class="text_16_500_212b36">Quantity Ordered</span></div>
                                <div style="flex:1;"><span class="text_16_500_212b36">Quantity Assigned</span></div>
                            </div>`);

                for(let i=0;i<products.length;i++)
                {
                    $('#finalProductDetails').append(productDetailsGenerator(products[i]));
                }

                $('#productModalTwo').modal('show');
            }

            function viewDetails(){

                $('#productDetails').empty();

                for(let pi in finalOrders)
                {
                    var missingProductsList = finalOrders[pi].missingProductsList;
                    var storeName = finalOrders[pi].storeName;

                    $('#productDetails').append(`<div class="flex-row" style="height:60px; padding-left:10px; border-radius:4px; background-color:#979797">
                                        <span class="text_16_500_212b36">${storeName}</span>
                                    </div>`)

                    $('#productDetails').append(`<div class="flex-row" style="padding-left:10px; height:60px;">
                                <div style="flex:3"><span class="text_16_500_212b36">Product Name</span></div>
                                <div style="flex:1;"><span class="text_16_500_212b36">Quantity Ordered</span></div>
                                <div style="flex:1;"><span class="text_16_500_212b36">Quantity Assigned</span></div>
                            </div>`);
                                    
                    for(let i=0;i<missingProductsList.length;i++)
                    {
                        x = missingProductsList[i];
                        $('#productDetails').append(productDetailsGenerator(x));
                    }
                }

                $('#productModal').modal('show');
            }

            function productDetailsGenerator(product){

                return  `<div class="flex-row" style="height:60px; padding-left:20px;">
                                    <div style="flex:3"><span class="text_14_500_565656">${product.productName}</span></div>
                                    <div style="flex:1;"><span class="text_14_500_565656">${product.quantityOrdered}</span></div>
                                    <div style="flex:1;"><span class="text_14_500_565656">${product.quantityAssigned}</span></div>
                                </div>`;
            }

            function getPendingPICount(){ 

                db.get(`SELECT count(*) as totalCount FROM piSummary AS A WHERE A.status='RECEIVED'`,(err,count)=>{
                    if(err){
                        console.log(err)
                    }
                    else{
                        console.log(count)
                        $('#pendingPICount').text(count.totalCount+' orders')
                    }
                })
                
            }
            
            function selectAll(){

                var input = $('input[type="checkbox"]')
                var element = $("#selectAll");
                proformaArray = [];
                
                console.log(element[0].checked)

                if(!element[0].checked){

                    for(let i=0;i<input.length;i++)
                    {
                    
                        let id = input[i].id;
                        proformaInvoiceID = id.substr(0,8);

                        if(proformaInvoiceID == "checkbox"){
                    
                            input[i].checked = false;
                        }
                    }

                    return false;
                }

                
                totalStockValue = 0;
                totalStockItems = 0;

                for(let i=0;i<input.length;i++)
                {
                   
                    let id = input[i].id;
                    proformaInvoiceID = id.substr(0,8);

                    if(proformaInvoiceID == "checkbox"){

                        actualID = id.substr(8,id.length);
                        proformaArray.push(actualID)

                        input[i].checked = true;
                    }
                }

                for(let i=0;i<proformaArray.length;i++)
                {
                    for(let j=0; j<outletList.length;j++)
                    {
                        if(proformaArray[i] == outletList[j].json.PISummary[0].proformaInvoiceID)
                        {
                            totalStockValue += outletList[j].json.PISummary[0].grossBill;
                            totalStockItems += outletList[j].json.PIDetail.length;
                            break;
                        }
                    }
                }

                totalStockValue = Math.round(totalStockValue);
                $('#totalSection').css('display','flex');
                $('#totalStockValue').text(totalStockValue);
                $('#totalStockItems').text(totalStockItems)

                // console.log(proformaArray)
            }

            function reload(){
                window.location.href = './pendingPIList.html';
            }

            function rowStyle(row,index){
                return {classes:'rowStyle'}
            }

            function goBack(){
                window.location.href = reRenderLocation;
            }

            function rowAttributes(row,index){

                return {id:'batch-'+row.batchVariantID+'-proforma-'+row.proformaInvoiceID}
            }

            function renderQuantity(value,row){
                return '<div class="flex-row"> <button class="cartBtn" id=decrement-batch-'+row.batchVariantID+'-proforma-'+row.proformaInvoiceID+' onclick="decrement(this)">-</button> <input style="border:0px; text-align:center; margin:0px; width:60px;" type="number" min="0" class="confirmation" id=quantity-batch-'+row.batchVariantID+'-proforma-'+row.proformaInvoiceID+' data-batchID='+row.batchVariantID+' value='+row.quantityOrdered+' data-value='+row.productID+' data-target='+row.proformaInvoiceID+' onkeypress="return event.charCode >= 48" onchange="handleChange(this)"></input> <button class="cartBtn" id=increment-batch-'+row.batchVariantID+'-proforma-'+row.proformaInvoiceID+' onclick="increment(this)">+</button> </div>';
            }

            function decrement(element){

                let id = element.id;
                id = id.substr(10,id.length);
                id = '#quantity-'+id;

                let q = $(id).val();

                if(q > 0){
                    --q;
                }
                
                $(id).val(q);
                console.log(id)
            }

            function increment(element){

                let id = element.id;
                id = id.substr(10,id.length);
                id = '#quantity-'+id;

                let q = $(id).val();
                q++;
                
                $(id).val(q);
                console.log(id)
            }

            function deleteBatch(value,row){

                return '<div style="cursor:pointer;" onclick="handleDelete(this)" id=delete-batch-'+row.batchVariantID+'-proforma-'+row.proformaInvoiceID+'> <img src = "../../assets/img/trash-gray.png"> </div>';
            }

            function handleDelete(element){

                var id = element.id;
                id = id.substr(7,id.length)
                id = '#'+id;
                deleteID = id;

                $('#deleteModal').modal('show');
            }

            function finalDelete(){

                $(deleteID).remove();
                $('#deleteModal').modal('hide');
            }           

            function handleChange(element){

                var batchID = element.id;
                var value = element.value;
                var productID = $(element).data('value');
                var proformaID = $(element).data('target');

                console.log(batchID,proformaID,productID,value)
            }

            function confirm(){

                var inputs = $('.confirmation');
                var demand = [];
                currentExOrderID = 0;
                
                // console.log(inputs)

                if(inputs.length == 0){

                    var dialogOptions = {type: 'info', buttons: ['OK'], message: 'No quantity allocated to any Market Order'}
                
                    dialog.showMessageBox(dialogOptions, async i => {
                        
                    }) 
            
                    return;
                }

                // assigning value = 0 for all undefined inputs

                for(let i=0;i<inputs.length;i++)
                {
                    if(inputs[i].value == ""){
                        inputs[i].value = 0;
                    }
                }

                // creating the new list of quantities assigned by the user to the products

                for(let i=0;i<inputs.length;i++)
                {
                    var pi = inputs[i].dataset.target;
                    var productID = inputs[i].dataset.value;
                    productID = JSON.stringify(productID);
                    var quantity = JSON.parse(inputs[i].value);

                    if(demand[pi] !== undefined){

                        if(demand[pi].productsList[productID] !== undefined){
                            demand[pi].productsList[productID].quantityOrdered += quantity;
                        }
                        else{
                            demand[pi].productsList[productID] = {};
                            demand[pi].productsList[productID].quantityOrdered = quantity;   
                        }
                    }
                    else{
                        demand[pi] = {productsList:[]};

                        if(demand[pi].productsList[productID] !== undefined){
                            demand[pi].productsList[productID].quantityOrdered += quantity;
                        }
                        else{
                            demand[pi].productsList[productID] = {};
                            demand[pi].productsList[productID].quantityOrdered = quantity;   
                        }
                    }
                }

                console.log(demand)

                // New quantity allocated by SS to a product in an order shouldn't be greater than
                // the original quantity ordered by the user

                for(let proformaId in demand)
                {
                   var demandList = demand[proformaId].productsList;
                   var cartProducts;

                   for(let j=0;j<cart.length;j++)
                   {
                       if(proformaId == cart[j].proformaID){

                            cartProducts = cart[j].finalProducts;
                            break;
                       }
                   }

                   console.log(demandList,cartProducts)

                   for(let productID in demandList)
                   {
                       for(let i=0;i<cartProducts.length;i++)
                       {

                            if(JSON.parse(productID) == JSON.stringify(cartProducts[i].productID)){

                                if(demandList[productID].quantityOrdered > cartProducts[i].quantityOrdered)
                                {
                                    console.log('product demand greater than original quantity ordered',proformaId,cartProducts[i].productName)
                                    // alert('Product '+cartProducts[i].productName+' allocated quantity greater than original quantity ordered in '+proformaId)
                                   
                                   var dialogOptions = {type: 'info', buttons: ['OK'], message: 'Product '+cartProducts[i].productName+' allocated quantity greater than original quantity ordered in '+proformaId}
                
                                    dialog.showMessageBox(dialogOptions, async i => {
                                        
                                    })
                                    return;
                                }

                                break;
                            }
                       }    
                   }

                }

                // New quantity allocated by the SS to a product across all the orders
                // shouldn't be greater than the inventory of the product

                var demandProductsQuantityList = [];

                for(let pi in demand)
                {
                    var productsList = demand[pi].productsList;

                    for(let productID in productsList)
                    {
                        if(demandProductsQuantityList[productID] !== undefined){
                            demandProductsQuantityList[productID].quantityOrdered += parseInt(productsList[productID].quantityOrdered);
                        }
                        else{
                            demandProductsQuantityList[productID] = {};
                            demandProductsQuantityList[productID].quantityOrdered = parseInt(productsList[productID].quantityOrdered);
                        }
                    }
                }

                console.log(demandProductsQuantityList)
                // console.log(stockProducts)

                for(let productID in demandProductsQuantityList)
                {
                    for(let id in stockProducts)
                    {
                        if(productID == id)
                        {
                            if(demandProductsQuantityList[productID].quantityOrdered > stockProducts[id].inventoryAmount)
                            {
                                console.log('product demand greater than inventory amount ',productID)
                                // alert('Quantity allocated to product '+stockProducts[id].productName+' across all orders is greater than product inventory')
                                
                                var dialogOptions = {type: 'info', buttons: ['OK'], message: 'Quantity allocated to product '+stockProducts[id].productName+' across all orders is greater than product inventory'}
                
                                dialog.showMessageBox(dialogOptions, async i => {
                                    
                                })
                                return;
                            }
                            break;
                        }
                    }
                }

                // total quantity ordered for a batch across all the orders should
                // not be greater than the inventory of the batch

                var batchesQuantityList = [];

                for(let i=0;i<inputs.length;i++)
                {
                //    var batchID = JSON.stringify(inputs[i].id);
                    var batchID = JSON.stringify(inputs[i].dataset.batchid);
                    var value = parseInt(inputs[i].value);

                    if(batchesQuantityList[batchID] !== undefined){
                        batchesQuantityList[batchID].quantityOrdered += value;  
                    }
                    else{
                        batchesQuantityList[batchID] = {};
                        batchesQuantityList[batchID].quantityOrdered = value;
                    }
                }

                console.log(batchesQuantityList)

                for(let batchID in batchesQuantityList)
                {
                    for(i=0;i<batchVariant.length;i++)
                    {
                        let id = JSON.stringify(batchVariant[i].batchVariantID);
                        if(JSON.parse(batchID) == id)
                        {
                            if(batchesQuantityList[batchID].quantityOrdered > batchVariant[i].inventory)
                            {
                                console.log('demand greater than batch inventory in ',id,batchVariant[i].batchVariantName)
                                console.log('batch inventory ',batchVariant[i].inventory)
                                // alert('Inventory limit exceeded in batch variant '+batchVariant[i].batchVariantName)
                                
                                var dialogOptions = {type: 'info', buttons: ['OK'], message: 'Inventory limit exceeded in batch variant '+batchVariant[i].batchVariantName}
                
                                dialog.showMessageBox(dialogOptions, async i => {
                                    
                                })
                                return;
                            }
                            break;
                        }
                    }
                }            

                var orders = [];

                for(let i=0;i<inputs.length;i++)
                {
                    var pi = inputs[i].dataset.target;
                    var batchid = inputs[i].dataset.batchid;
                    batchid = JSON.stringify(batchid);
                    var quantity = JSON.parse(inputs[i].value);

                    if(quantity == 0){
                        continue;
                    }

                    if(orders[pi] !== undefined){

                        if(orders[pi].batchList[batchid] !== undefined){
                            orders[pi].batchList[batchid].quantityOrdered += quantity;
                        }
                        else{
                            orders[pi].batchList[batchid] = {};
                            orders[pi].batchList[batchid].quantityOrdered = quantity;   
                        }

                        orders[pi].totalQuantityOrdered += quantity;  
                    }
                    else{

                        orders[pi] = {batchList:[]};
                        orders[pi].totalQuantityOrdered = 0;

                        if(orders[pi].batchList[batchid] !== undefined){
                            orders[pi].batchList[batchid].quantityOrdered += quantity;
                        }
                        else{
                            orders[pi].batchList[batchid] = {};
                            orders[pi].batchList[batchid].quantityOrdered = quantity; 
                        }

                        orders[pi].totalQuantityOrdered += quantity;  
                    }
                }

                // delete those orders whose totalQuantityOrdered = 0

                for(let pi in orders)
                {
                    if(orders[pi].totalQuantityOrdered == 0){
                        
                        delete orders[pi];
                    }
                }

                // if there is no PI remaining then do not proceed
                
                var count = 0;

                for(let pi in orders)
                {
                    ++count;
                }

                if(count == 0){

                    // alert('No quantity allocated to any Market Order');

                    var dialogOptions = {type: 'info', buttons: ['OK'], message: 'No quantity allocated to any Market Order'}
                
                    dialog.showMessageBox(dialogOptions, async i => {
                        
                    })
                    return ;
                }

                // merging products demand into the order info

                for(let pi in orders)
                {
                    for(let j in demand)
                    {
                        if(pi == j)
                        {
                            orders[pi].finalProducts = demand[j].productsList;
                            break;
                        }
                    }
                }

                // making the final batches list

                for(let pi in orders)
                {
                    var batchList = orders[pi].batchList;
                    var finalBatches = [];

                    for(let batchID in batchList)
                    {
                        var quantityOrdered = batchList[batchID].quantityOrdered;

                        if(quantityOrdered){
                            for(let i=0;i<batchVariant.length;i++)
                            {
                                if(JSON.parse(batchID) == JSON.stringify(batchVariant[i].batchVariantID))
                                {
                                    var x = $.extend(true,{},batchVariant[i]);
                                    x.quantityOrdered = quantityOrdered;
                                    x.quantityOrderedCost = x.turPerUnit * x.quantityOrdered;
                                    x.quantityOrderedCost = Math.round(x.quantityOrderedCost * 100)/100;

                                    finalBatches.push(x)
                                    break;
                                }
                            }
                        }
                    }

                    orders[pi].productList = finalBatches;
                }

                // calculating the taxes on the batches

                // for(let pi in orders)
                // {
                //     var productList = orders[pi].productList;
                //     taxCalculator(productList);
                // }


                // this code is for setting the fields for discount calculation

                for(let pi in orders)
                {
                    var productList = orders[pi].productList;
                    setTaxFields(productList);
                }

                // assigning the whole product object to the productList

                for(let pi in orders)
                {
                    var productList = orders[pi].productList;
                    productToBatchMapper(pi,productList);
                }

                for(let pi in orders)
                {
                    orders[pi].proformaID = pi;

                    for(let j=0; j<outletList.length;j++)
                    {
                        if(pi == outletList[j].proformaInvoiceID)
                        {
                            customerID = outletList[j].json.customerInfo[0].customerID;
                            orders[pi].customerID = customerID;
                            orders[pi].externalOrderID = outletList[j].json.PISummary[0].externalOrderID;
                            break;
                        }
                    }
                }

                // code for setting the schemes and discounts

                for(let pi in orders)
                {
                    var cartBatchData =  orders[pi].productList
                    var customerID = orders[pi].customerID
                    customerDiscountAppliedIDs = discountAppliedIDs.filter(m=>m.customerID == customerID)
                    console.log(customerDiscountAppliedIDs,'customerDiscountAppliedIDs')
                    cartBatchData =  handleDiscountToCart(cartBatchData,discountProductList,customerDiscountAppliedIDs,discountLevelList,discountDetails,discountClusters)
                }

                // code for calculating the taxes

                for(let pi in orders)
                {
                    var productList = orders[pi].productList;
                    taxCalculator(productList);
                }

                finalView(orders);
            }

            function setTaxFields(productList){

                for(let i=0;i<productList.length;i++)
                {

                    var totalTaxPercentage = 0;

                    for(let j=0;j<productList[i].taxes.length;j++){
                    
                        totalTaxPercentage += productList[i].taxes[j].taxPercentage;
                    }

                    total = 1 + totalTaxPercentage/100;
                    console.log(total)
                    productList[i].totalTaxPercentage = totalTaxPercentage;
                    productList[i].productBasePrice = productList[i].turPerUnit/total;
                    productList[i].productActualPrice = productList[i].turPerUnit;
                }   
            }

            function taxCalculator(productList){

                for(let i=0;i<productList.length;i++)
                {

                    var totalTaxPercentage = 0;

                    for(let j=0;j<productList[i].taxes.length;j++){
                    
                        totalTaxPercentage += productList[i].taxes[j].taxPercentage;
                    }

                    total = 1 + totalTaxPercentage/100;

                    if(productList[i].productBasePrice){
                        productList[i].itemSales = productList[i].productBasePrice * productList[i].quantityOrdered;
                        productList[i].taxableValue = productList[i].itemSales - (productList[i].stprDiscountValues + productList[i].stprCashDiscountValues );      
                        productList[i].totalTaxValue = productList[i].taxableValue * totalTaxPercentage/100;
                        productList[i].productValue = productList[i].taxableValue + productList[i].totalTaxValue - productList[i].btprDiscountValues;
                        productList[i].productValue = Math.round(productList[i].productValue * 100)/100;
                    }
                    else{
                        productList[i].itemSales = 0;
                        productList[i].taxableValue = 0;      
                        productList[i].totalTaxValue = 0;
                        productList[i].productValue = 0;
                    }

                    for(let j=0;j<productList[i].taxes.length;j++){
                    
                        let x = productList[i].taxes[j].taxPercentage;  
                        let tax = productList[i].taxableValue;

                        let y = tax * x/100;

                        productList[i].taxes[j].taxValue = Math.round(y * 100)/100;
                    }
                }
            }

            function productToBatchMapper(pi,productList){

                // var products = [];

                // for(let j=0; j<outletList.length;j++)
                // {
                //     if(pi == outletList[j].proformaInvoiceID)
                //     {
                //         products = outletList[j].json.PIDetail;
                //         break;
                //     }
                // }

                var products = allProductsList;

                for(let i=0;i<productList.length;i++)
                {

                    var batchVariantID = productList[i].batchVariantID;
                    var batchVariantName = productList[i].batchVariantName;
                    var batchVarRefID = productList[i].batchVarRefID;
                    var inventory = productList[i].inventory;
                    var quantityOrdered = productList[i].quantityOrdered;
                    var quantityOrderedCost = productList[i].quantityOrderedCost;
                    var taxArr = productList[i].taxArr;
                    var taxes = productList[i].taxes;
                    var turPerUnit = productList[i].turPerUnit;
                    // var totalTaxValue = productList[i].totalTaxValue;
                    // var taxableValue = productList[i].taxableValue;
                    // var itemSales = productList[i].itemSales;
                    var productBasePrice = productList[i].productBasePrice;
                    var productActualPrice = productList[i].productActualPrice;
                    // var productValue = productList[i].productValue;
                    var sbomDesc = productList[i].sbomDesc;
                    var totalTaxPercentage = productList[i].totalTaxPercentage;

                    for(let j=0; j<products.length;j++)
                    {
                        if(productList[i].productID == products[j].productID)
                        {
                            var x = $.extend(true,{},products[j]);
                            
                            // console.log(x)

                            productList[i] = x;
                            productList[i].batchVariantID = batchVariantID;
                            productList[i].batchVariantName = batchVariantName;
                            productList[i].batchVarRefID = batchVarRefID;
                            productList[i].inventory = inventory;
                            productList[i].quantityOrdered = quantityOrdered;
                            productList[i].quantityOrderedCost = quantityOrderedCost;
                            productList[i].taxes = taxes;
                            productList[i].productBasePrice = Math.round(productBasePrice * 1000)/1000;
                            // productList[i].totalTaxValue = Math.round(totalTaxValue * 100)/100;
                            // productList[i].taxableValue = Math.round(taxableValue * 100)/100;
                            // productList[i].itemSales = Math.round(itemSales * 100)/100;
                            // productList[i].productValue = Math.round(productValue * 100)/100;
                            productList[i].turPerUnit = turPerUnit;
                            productList[i].sbomDesc = sbomDesc;
                            productList[i].discounts = [];
                            productList[i].discountValues = 0;
                            productList[i].btprDiscountValues = 0;
                            productList[i].stprDiscountValues = 0;
                            productList[i].stprCashDiscountValues = 0;
                            productList[i].totalTaxPercentage = totalTaxPercentage;
                            // productList[i].productActualPrice = Math.round(productActualPrice * 100)/100;
                            productList[i].productActualPrice = productActualPrice;



                            delete productList[i].quantityAssigned;
                            break;
                        }
                    }
                }
                
            }

            async function finalView(orders){

                finalOrders = orders;
                activePI = {pi:'',show:false};

                for(let pi in orders)
                {
                    orders[pi].proformaID = pi;

                    var products = [];
                    var productList = orders[pi].productList;
                    var finalProducts = orders[pi].finalProducts;
                    var sales = grossSale = discountValues = 0,PIDetail,posDate;

                    for(let j=0; j<outletList.length;j++)
                    {
                        if(pi == outletList[j].proformaInvoiceID)
                        {
                            storeName = outletList[j].json.customerInfo[0].firstName;
                            customerID = outletList[j].json.customerInfo[0].customerID;
                            posDate = outletList[j].json.PISummary[0].posDate;
                            PIDetail = outletList[j].json.PIDetail;
                            

                            orders[pi].storeName = storeName;
                            orders[pi].posDate = posDate;
                            orders[pi].customerID = customerID;
                            break;
                        }
                    }

                    
                    for(let i=0;i<productList.length;i++)
                    {
                        sales += productList[i].itemSales;
                        grossSale += productList[i].productValue;
                        discountValues += productList[i].discountValues;
                    }

                    orders[pi].sales = Math.round(sales*1000)/1000;
                    orders[pi].grossSale = Math.round(grossSale*1000)/1000;
                    orders[pi].discountValues = Math.round(discountValues*1000)/1000;

                    var missingProductsList = [];
                    
                    for(let i=0;i<PIDetail.length;i++)
                    {
                        var found = false;

                        for(let productID in finalProducts)
                        {   
                            if(JSON.stringify(PIDetail[i].productID) == JSON.parse(productID))
                            {

                                var obj = {
                                    productID: PIDetail[i].productID,
                                    productName : PIDetail[i].productName,
                                    quantityOrdered: PIDetail[i].quantityOrdered,
                                    quantityAssigned : finalProducts[productID].quantityOrdered,
                                }

                                missingProductsList.push(obj)

                                found = true;
                                break;
                            }
                        }

                        if(!found)
                        {
                            var obj = {
                                productID: PIDetail[i].productID,
                                productName : PIDetail[i].productName,
                                quantityOrdered: PIDetail[i].quantityOrdered,
                                quantityAssigned : 0
                            }

                            missingProductsList.push(obj);
                        }
                    }


                    for(let i=0;i<missingProductsList.length;i++)
                    {
                        var productID = missingProductsList[i].productID;

                        for(let j=0;j<allProductsList.length;j++)
                        {
                            if(productID == allProductsList[j].productID)
                            {
                                missingProductsList[i].price = Math.round(allProductsList[j].price * 100)/100;
                                break;
                            }
                        }
                    }

                    orders[pi].missingProductsList = missingProductsList;
                }                

                // code for creating the child batchess

                await childBatchesCreator();


                // code for assigning total quantity ordered

                for(let pi in orders)
                {
                    var productList = orders[pi].productList;
                    var totalQuantityOrdered = 0;

                    for(let i=0;i<productList.length;i++)
                    {
                        totalQuantityOrdered += productList[i].quantityOrdered;
                    }

                    orders[pi].totalQuantityOrdered = totalQuantityOrdered;
                }

                // code for calculating product level data for display

                // for(let pi in orders)
                // {
                //     var productList = orders[pi].productList;
                //     var searchList = [];

                //     for(let i=0;i<productList.length;i++)
                //     {
                //         var found = false;

                //         for(let k=0;k<searchList.length;k++)
                //         {
                //             if(productList[i].productID == searchList[k].productID){
                                
                //                 found = true;

                //                 searchList[k].quantityOrdered += productList[i].quantityOrdered;
                //                 searchList[k].productValue += productList[i].productValue;
                //                 searchList[k].discountValues += productList[i].discountValues;
                //                 searchList[k].taxableValue += productList[i].taxableValue;

                //                 break;
                //             }
                //         }

                //         if(!found)
                //         {
                //             var x = $.extend(true,{},productList[i]);
                //             // var x = {
                //             //     productID : productList[i].productID,
                //             //     quantityOrdered : productList[i].quantityOrdered,
                //             //     productValue : productList[i].productValue,
                //             //     discountValues : productList[i].discountValues,
                //             //     taxableValue : productList[i].taxableValue,
                //             //     taxes : productList[i].taxes
                //             // }
                //             searchList.push(x);
                //         }
                    
                //     }

                //     // code for rounding values

                //     for(let i=0;i<searchList.length;i++)
                //     {
                //         searchList[i].productValue = Math.round(searchList[i].productValue * 100)/100;
                //         searchList[i].discountValues = Math.round(searchList[i].discountValues * 100)/100;
                //         searchList[i].taxableValue = Math.round(searchList[i].taxableValue * 100)/100;
                //     }
                    
                //     orders[pi].combinedProducts = searchList;
                // }                

                console.log('finalOrders ',finalOrders)

                $('#finalOrders').empty();

                $('#finalOrders').append(`<div class="flex-row" style="justify-content:space-between; padding:16px; border-bottom: solid 1px #979797;">
                                <div style="flex:4"><span class="text_16_500_212b36">StoreName</span></div>
                                <div style="flex:1"><span class="text_16_500_212b36">PosDate</span></div>
                                <div style="flex:1"><span class="text_16_500_212b36">Units</span></div>
                                <div style="flex:1"><span class="text_16_500_212b36">GrossSale</span></div>
                                <div style="flex:2"></div>
                            </div>`)

                for(let id in orders)
                {
                    $('#finalOrders').append(finalOrderGenerator(orders[id],id));
                }

                // new code 
                // code for calculating collective grossSale and discount

                var totalGrossSale = 0;
                var totalQuantityOrdered = 0;
                var totalDiscount = 0;

                details = [];

                for(let id in orders)
                {
                    details.push({
                        pi: id,
                        show:false
                    })

                    // var finalProducts = orders[id].finalProducts;
                    // var c = 0;

                    // for(let j in finalProducts)
                    // {
                    //     c++;
                    // }

                    // totalQuantityOrdered += c;

                    totalGrossSale += orders[id].grossSale;
                    totalQuantityOrdered += orders[id].productList.length;
                    totalDiscount += orders[id].discountValues;
                }

                totalGrossSale = Math.round(totalGrossSale);
                // totalGrossSale = Math.round(totalGrossSale * 1000)/1000;
                totalDiscount = Math.round(totalDiscount * 1000)/1000;

                $('#totalGrossSale').text(totalGrossSale);
                $('#totalQuantityOrdered').text(totalQuantityOrdered);
                $('#totalDiscount').text(totalDiscount);

                $('#confirmationSection').css('display','none');
                $('#finalView').css('display','flex');

            }

            function finalOrderGenerator(order,pi){

                return  `
                        <div id="final_${pi}" class="flex-column">
                            <div class="flex-row" style="padding: 16px; border-bottom:solid 1px #979797; justify-content:space-between;">
                                <div style="flex:4"><span class="text_14_500_565656">${order.storeName}</span></div>
                                <div style="flex:1"><span class="text_14_500_565656">${order.posDate}</span></div>
                                <div style="flex:1"><span class="text_14_500_565656">${order.totalQuantityOrdered}</span></div>
                                <div style="flex:1"><span class="text_14_500_565656">${order.grossSale}</span></div>
                                <div style="flex:1; text-align:center;"><span class="text_14_500_1766a6" style="cursor:pointer;" id="nonAllocated_${pi}" onclick=viewNonAllocated(this)>View Non allocated basepack</span></div>                                
                                <div style="flex:1; text-align:center;"><span class="text_14_500_1766a6" style="cursor:pointer;" id="open_${pi}" onclick=openDetails(this)>Open Details</span></div>
                            </div>

                            <div id="final_table_${pi}" class="flex-column" style="display:none;">
                            </div>
                        </div>`;
            }

            function openDetails(element){

                var pi = element.id;
                pi = pi.substr(5,pi.length);

                console.log(pi)

                if(activePI.pi == pi){
                    
                    if(activePI.show){
                        activePI.show = false;
                        $('#final_table_'+pi).css('display','none');
                    }
                    else{
                        activePI.show = true;
                        $('#final_table_'+pi).css('display','flex');
                    }

                    return;
                }

                activePI.pi = pi;
                activePI.show = true;

                for(let id in finalOrders)
                {
                    if(pi == id)
                    {
                        var productList = finalOrders[id].productList;
                    }

                    $('#final_table_'+id).css('display','none')
                }

                pi = '#final_table_'+pi;
                $(pi).empty();

                var header =    `<div class="flex-row" style="flex:1; justify-content:space-between; padding:16px; background:#eff1f3; border-bottom:solid 1px #979797">
                                    <div style="flex:4"><span class="text_16_500_1766a6">Batch Variant</span></div>
                                    <div style="flex:1"><span class="text_16_500_1766a6">TUR</span></div>
                                    <div style="flex:1"><span class="text_16_500_1766a6">UPC</span></div>
                                    <div style="flex:1"><span class="text_16_500_1766a6">Units</span></div>
                                    <div style="flex:1"><span class="text_16_500_1766a6">Discount</span></div>
                                    <div style="flex:1"><span class="text_16_500_1766a6">Final Price</span></div>
                                </div>`;
                                
                $(pi).append(header);

                for(let i=0; i<productList.length; i++)
                {
                    $(pi).append(finalProductGenerator(productList[i]));
                }

                $(pi).css('display','flex');

            }

            function finalProductGenerator(product){
                 
                return  `<div class="flex-row" style="flex:1; justify-content:space-between; padding:16px; background:#eff1f3; border-bottom:solid 1px #979797">
                            <div style="flex:4"><span class="text_14_500_565656">${product.batchVariantName}</span></div>
                            <div style="flex:1"><span class="text_14_500_565656">${product.turPerUnit}</span></div>
                            <div style="flex:1"><span class="text_14_500_565656">${product.unitsPerCase}</span></div>
                            <div style="flex:1"><span class="text_14_500_565656">${product.quantityOrdered}</span></div>
                            <div style="flex:1"><span class="text_14_500_565656">${product.discountValues}</span></div>
                            <div style="flex:1"><span class="text_14_500_565656">${product.productValue}</span></div>
                        </div>`;
            }

            function viewNonAllocated(element){
                nonAllocatedProducts = []
                var pi = element.id;
                pi = pi.substr(13,pi.length)
                var order;
                for(let id in finalOrders)
                {
                    if(pi == id)
                    {
                        order = finalOrders[id];
                        break;
                    }
                }

                var displayList =  order.missingProductsList;
                currentExOrderID=order.externalOrderID
                console.log(currentExOrderID,'currentExOrderID')
                $('#basepack').empty();
                $('#basepack').append(`<div class="flex-row" style="height:60px;">
                                <div style="flex:3"><span class="text_16_500_212b36">Product Name</span></div>
                                <div style="flex:1;"><span class="text_16_500_212b36">Price</span></div>
                                <div style="flex:1;"><span class="text_16_500_212b36">Ordered</span></div>
                                <div style="flex:1;"><span class="text_16_500_212b36">Non Allocated</span></div>
                            </div>`)

                for(let i=0;i<displayList.length;i++)
                {
                    $('#basepack').append(nonAllocatedGenerator(displayList[i]));
                }

                $('#basepackModal').modal('show');

            }

            function nonAllocatedGenerator(product){
                
                var nonAllocated = product.quantityOrdered - product.quantityAssigned;

                if(nonAllocated)
                {
                    nonAllocatedProducts.push(product)
                    return  `<div class="flex-row" style="height:60px;">
                                <div style="flex:3"><span class="text_14_500_565656">${product.productName}</span></div>
                                <div style="flex:1;"><span class="text_14_500_565656">${product.price}</span></div>
                                <div style="flex:1;"><span class="text_14_500_565656">${product.quantityOrdered}</span></div>
                                <div style="flex:1;"><span class="text_14_500_565656">${nonAllocated}</span></div>
                            </div>`
                }                                   
            }
            
            function closeModal(element){

                var id = '#' + $(element).data('target');
                $(id).modal('hide');
            }

            function closeModalTwo(){

                $('#basepackModalTwo').modal('hide');
            }

            function assignAgain(){

                $('#finalView').css('display','none');
                $('#confirmationSection').css('display','flex');
            }

            async function childBatchesCreator(){

                childBatches = [];
                var linkage = [];

                for(let pi in finalOrders)
                {
                    var productList = finalOrders[pi].productList;
                    var childList = [];

                    for(let i=0; i<productList.length; i++)
                    {
                     
                        if(productList[i].sbomDesc == 'LSBOM-P')
                        {
                            await new Promise((resolve,reject)=>{

                                db.get(`SELECT cpLinkage, parentSkuQty, childSkuQty from storeRegion WHERE batchVariantID = ${productList[i].batchVarRefID}`,function(error,data){

                                    if(error){
                                        console.log(error)
                                    }
                                    else{
                                        console.log(data)
                                        if(data){
                                            productList[i].cpLinkage = data.cpLinkage;
                                            productList[i].parentSkuQty = parseInt(data.parentSkuQty);
                                            productList[i].childSkuQty = parseInt(data.childSkuQty);

                                            productList[i].childItem = {
                                                aipPerCase:0,
                                                aipPerUnit:0,
                                                basePackCode:0,
                                                batchVariantID:'',
                                                childSkuQty: productList[i].childSkuQty,
                                                cpLinkage: productList[i].cpLinkage,
                                                mrpPerCase:0,
                                                mrpPerUnit:0,
                                                parentSkuQty: productList[i].parentSkuQty,
                                                productID:0,
                                                turPerCase:0,
                                                turPerUnit:0,
                                                variantID:0
                                            }
                                        }                                    
                                        resolve();
                                    }
                                })
                            })
                            
                            await new Promise((resolve,reject)=>{

                                db.get(`SELECT batchVarRefID,productID FROM batchProductVariants WHERE serialNumber = "${productList[i].cpLinkage}"`,function(err,data){
                                    
                                    if(err){
                                        console.log(err)
                                    }
                                    else{
                                        
                                        productList[i].childItem.batchVariantID = data.batchVarRefID;
                                        productList[i].childItem.productID = data.productID;
                                        resolve();
                                    }
                                })
                            })             
                        }

                        else{
                            productList[i].childItem = {
                                aipPerCase:0,
                                aipPerUnit:0,
                                basePackCode:0,
                                batchVariantID: productList[i].batchVariantID,
                                childSkuQty: 0,
                                cpLinkage: 0,
                                mrpPerCase:0,
                                mrpPerUnit:0,
                                parentSkuQty: 0,
                                productID:0,
                                turPerCase:0,
                                turPerUnit:0,
                                variantID:0
                            }
                        }            
                    }

                    for(let i=0; i<productList.length; i++)
                    {
                        if(productList[i].sbomDesc == "LSBOM-P" && productList[i].cpLinkage !== undefined)
                        {
                            console.log(productList[i].batchVariantID,productList[i].sbomDesc,productList[i].cpLinkage);

                            var found = false;

                            for(let j=0;j<linkage.length;j++)
                            {
                                if(productList[i].cpLinkage == linkage[j])
                                {
                                    found = true;
                                    break;
                                }
                            }

                            if(!found){

                                linkage.push(productList[i].cpLinkage)

                                await new Promise((resolve,reject)=>{

                                    db.all(`SELECT * FROM batchProductVariants WHERE serialNumber = "${productList[i].cpLinkage}" AND inventory > 0 order by manufacturingDate asc `,function(err,data){
                                        
                                        if(err){
                                            console.log(err)
                                        }
                                        else{
                                            console.log('child batches of '+productList[i].cpLinkage,data)
                                            childBatches = childBatches.concat(data);
                                            resolve();
                                        }
                                    })
                                })
                            }
                        }   
                    }   
                }

                // code for globaly setting the chidBatches currentInventory

                for(let i=0;i<childBatches.length;i++)
                {
                    childBatches[i].totalQuantityOrdered = 0;
                    childBatches[i].currentInventory = childBatches[i].inventory;
                }

                console.log('linkages ',linkage)

                // code for creating child batches

                for(let pi in finalOrders)
                {
                    var productList = finalOrders[pi].productList;
                    var childList = [];

                    for(let i=0;i<productList.length;i++)
                    {
                        var temp = handleChildProductBatchToCart(productList[i]);

                        if(temp.length > 0){

                            for(let i=0;i<temp.length;i++)
                            {
                                var found = false;

                                for(let j=0;j<childList.length;j++)
                                {   
                                    if(temp[i].batchVariantID == childList[j].batchVariantID)
                                    {
                                        childList[j].quantityOrdered += temp[i].quantityOrdered;
                                        childList[j].totalQuantityOrdered = temp[i].totalQuantityOrdered;
                                        childList[j].currentInventory = temp[i].currentInventory;

                                        found = true;
                                        break;
                                    }
                                }

                                if(!found)
                                {
                                    childList.push(temp[i]);
                                }
                            }
                        }
                    }

                    await productToChildBatchMapper(childList);
                    finalOrders[pi].childList = childList;     
                    finalOrders[pi].productList = finalOrders[pi].productList.concat(childList);
                }

            }

            async function generateBill(){

                // code for assigning credit notes and then inserting the order into orderInfo
                $('#bill').attr('disabled',true);

                for(let pi in finalOrders)
                {
                    finalOrders[pi].grossSale = Math.round(finalOrders[pi].grossSale)   
                    finalOrders[pi].paymentList = await applyCreditNotes(finalOrders[pi].customerID,finalOrders[pi].grossSale)
                    await orderInfoGenerator(finalOrders[pi]);
                }

                $('#generateBill').modal('show');
                noPrint = true;
                console.log('finalOrders',finalOrders)

            }
            
            handleDiscountToCart = (cartBatchData,discountProductList,discountAppliedIDs,discountLevelList,discountDetails,discountClusters)=>{
                
                var cartBatchDataWithSchemes = cartBatchData
                var cashDiscArray=[]

                cartBatchDataWithSchemes.map((l)=>{ 
                    l['discounts'] = []
                    l['discountValues'] = 0
                    l['stprDiscountValues'] = 0
                    l['btprDiscountValues'] = 0
                    l['stprCashDiscountValues'] = 0
                }) 
                            
                discountAppliedIDs.map(a=>{
                    discountProductList.map((b)=>{
                        appliedDiscountLevel = []
                        appliedDiscountDetailsObj = {}
                        appliedDiscountProductMapping = {}

                        if(a.discountID == b.discountID){
                            appliedDiscountProductMapping = b
                            appliedDiscountID = b.discountID
                            prodArry =  (b.discountProductList).split(",")
                            batchArry =  (b.discountProdBatchVariantList).split("|")
                            batchArry.pop()
                            eligibleQuant = 0;
                            eligibleValue = 0;
                            eligibleValueByActualPrice = 0;
                            eligibleWeight = 0;
                            eligibleQuantValue = 0;
                            eligibleTotalWeightValue = 0;
                            applicableCartBatches = []

                            prodArry.map((c,i)=>{
                                filteredCartBatches = []
                                if(c=='ALL'){
                                    filteredCartBatches = cartBatchDataWithSchemes
                                }
                                else{
                                    if(batchArry[i]=='ALL'){
                                        filteredCartBatches = cartBatchDataWithSchemes.filter(d=>c==d.productID)
                                    }
                                    else{
                                        if(batchArry[i]){
                                            eligibleBatchesID = batchArry[i].split(",")
                                            filteredCartBatches = cartBatchDataWithSchemes.filter(o2 => eligibleBatchesID.some(o1 => o1== o2.batchVarRefID));
                                        }
                                    }
                                }
                                if(filteredCartBatches.length){
                                    applicableCartBatches = [...applicableCartBatches,...filteredCartBatches]
                                }
                            })
                            
                            applicableCartBatches=applicableCartBatches.filter(z=> z.quantityOrdered>0 && z.sbomDesc != "LSBOM-C")
                            if(applicableCartBatches.length){
                                console.log(applicableCartBatches,'applicableCartBatches')

                                appliedDiscountDetailsObj = discountDetails.find(f=>f.discountID == appliedDiscountID)
                                appliedDiscountLevel = discountLevelList.filter(g=>g.discountID ==appliedDiscountID)
                                
                                var cumBilledQty;
                                var billedQty;
                                var billedValue;
                                var billSchemeValue;
                                var discountValue;
                                var finalDiscountValue;

                                var eligibleAppliedDiscountLevel;

                                if(appliedDiscountDetailsObj.activityClassification=='SECONDARY TPR'){
                                    appliedDiscountClusters =  discountClusters.filter(y=>y.discountID==appliedDiscountID)

                                    var clusterCount=0;
                                    var eligibleValue=0;
                                    var btprApplicableBatches=[]
                                    appliedDiscountClusters.map(w=>{
                                        var addCluster = false;
                                        clusterProdList = (w.productList).split(",")
                                        applicableCartBatches.map((x)=>{
                                            if(clusterProdList.indexOf(`${x.productID}`) != -1){
                                                addCluster = true
                                                console.log(x.productID,'x.productID',appliedDiscountClusters)
                                                filteredBtprCartBatches = applicableCartBatches.filter(s=> s.batchVariantID==x.batchVariantID)
                                                if(filteredBtprCartBatches.length){
                                                    btprApplicableBatches = [...btprApplicableBatches,...filteredBtprCartBatches]
                                                }
                                            }
                                            // else{
                                            //     btprApplicableBatches=btprApplicableBatches.filter(s=>s.productID!=x.productID)
                                            //    // btprApplicableBatches = [...btprApplicableBatches,...filteredBtprBatches]
                                            // }
                                        })
                                        if(addCluster){
                                            clusterCount++;
                                        }
                                    })

                                    if(clusterCount){
                                        console.log(clusterCount,'clusterCount',btprApplicableBatches)
                                        eligibleAppliedDiscountLevel = appliedDiscountLevel.find(h=>(clusterCount >= h.fromQuantity &&  clusterCount <= h.toQuantity))
                                        console.log(eligibleAppliedDiscountLevel,'eligibleAppliedDiscountLevel')
                                    }
                                
                                    if(eligibleAppliedDiscountLevel){
                                        var discountType = eligibleAppliedDiscountLevel.discountType
                                        if(discountType == 'PERCENTAGE'){
                                            btprApplicableBatches.map((j)=>{
                                                cDiscountDetailsObj = JSON.parse(JSON.stringify(appliedDiscountDetailsObj));
                                                eligibleValue = j.turPerUnit * j.quantityOrdered
                                                discountValue =(eligibleValue * eligibleAppliedDiscountLevel.discountValue/ 100);

                                                cDiscountDetailsObj['discountValue'] =  eligibleAppliedDiscountLevel.discountValue
                                                cDiscountDetailsObj['discountPrice'] = parseFloat(discountValue.toFixed(3))
                                                cDiscountDetailsObj['btprDiscountValue'] = parseFloat(discountValue.toFixed(3));
                                                cDiscountDetailsObj['stprDiscountValue'] = 0
                                                cDiscountDetailsObj['stprCashDiscountValue'] = 0
                                                cDiscountDetailsObj['discountType'] = 'PERCENTAGE'
                                                cDiscountDetailsObj['discountLevel'] = appliedDiscountLevel
                                                cDiscountDetailsObj['discountProductMap'] = appliedDiscountProductMapping
                                                cDiscountDetailsObj['discountClusters'] = appliedDiscountClusters

                                                if(j.discounts){
                                                    j.discounts = j.discounts.filter(k=>k.discountID!=cDiscountDetailsObj.discountID)
                                                    j.discounts = [...(j.discounts),cDiscountDetailsObj]
                                                }else{        
                                                    j['discounts'] = [cDiscountDetailsObj]
                                                }
                                                discntArry =   j.discounts
                                                discSum = 0
                                                btprDiscSum = 0
                                                discntArry.map(v=>{
                                                    discSum += v.discountPrice
                                                    btprDiscSum +=v.btprDiscountValue
                                                })
                                                j.discountValues = parseFloat(discSum.toFixed(3))
                                                j.btprDiscountValues = parseFloat(btprDiscSum.toFixed(3))
                                            })
                                            console.log(btprApplicableBatches,'btprApplicableBatches')
                                        }
                                    }
                                }
                            else{
                                if(appliedDiscountDetailsObj.isCashDiscount){
                                    cashDiscArray =cashDiscArray.filter(a=>a.discountID!=appliedDiscountDetailsObj.discountID)
                                    appliedDiscountDetailsObj['discountLevel'] = appliedDiscountLevel
                                    appliedDiscountDetailsObj['discountProductMap'] = appliedDiscountProductMapping
                                    cashDiscArray.push(appliedDiscountDetailsObj)

                                    console.log(cashDiscArray,'cashDiscArray')
                                }
                                else{              
                                    applicableCartBatches.map(e=>{
                                        eligibleQuant +=e.quantityOrdered
                                        eligibleValue +=(e.productBasePrice*e.quantityOrdered)
                                        eligibleValueByActualPrice +=(e.productActualPrice*e.quantityOrdered)
                                        eligibleQuantValue +=(e.productBasePrice*e.quantityOrdered)
                                        if(e.weightUnit == "GMS" || e.weightUnit == "ML"){
                                            eligibleWeight +=(e.quantityOrdered*e.weight/1000)
                                            eligibleTotalWeightValue +=(e.productBasePrice*e.weight*e.quantityOrdered/1000)
                                        }
                                        else{
                                            eligibleWeight +=(e.quantityOrdered*e.weight)
                                            eligibleTotalWeightValue +=(e.productBasePrice*e.weight*e.quantityOrdered) 
                                        }
                                    })
                                    
                                    var eligibleValueByActualPriceRounded = parseInt(eligibleValueByActualPrice)
                                    var eligibleWeightRounded = parseInt(eligibleWeight)
                
                                        var discountSchemeBasis = appliedDiscountLevel[0].schemeBasis
                                        switch(discountSchemeBasis){
                                            case 'UNIT':
                                            eligibleAppliedDiscountLevel = appliedDiscountLevel.find(h=>(eligibleQuant >= h.fromQuantity &&  eligibleQuant <= h.toQuantity))
                                            break;
                    
                                            case 'VALUE':
                                            eligibleAppliedDiscountLevel = appliedDiscountLevel.find(h=>(eligibleValueByActualPriceRounded >= h.fromQuantity &&  eligibleValueByActualPriceRounded <= h.toQuantity))
                                            break;
                    
                                            case 'WEIGHT':
                                            eligibleAppliedDiscountLevel = appliedDiscountLevel.find(h=>(eligibleWeightRounded >= h.fromQuantity &&  eligibleWeightRounded<= h.toQuantity))
                                            break;
                                        }
                                        console.log(discountSchemeBasis,'discountSchemeBasis',eligibleWeight,'eligibleWeight')
                                        if(eligibleAppliedDiscountLevel){
                                            if(discountSchemeBasis == 'WEIGHT'){
                                                var discountType = eligibleAppliedDiscountLevel.discountType
                        
                                                cumBilledQty = eligibleWeight;
                                                billedQty = parseInt(cumBilledQty /eligibleAppliedDiscountLevel.forEvery);
                        
                                                cumBilledValue= eligibleQuantValue
                                                billSchemeValue =(billedQty * eligibleAppliedDiscountLevel.forEvery) * (cumBilledValue / cumBilledQty);
                                                // billSchemeValue =parseFloat((billedQty * eligibleAppliedDiscountLevel.forEvery) * (cumBilledValue / cumBilledQty).toFixed(3));
                                                
                                                totalValue = eligibleTotalWeightValue
                    
                                                console.log(eligibleTotalWeightValue,eligibleWeight)
                                                if(discountType == 'PERCENTAGE'){
                                                    applicableCartBatches.map((j)=>{
                                                        cDiscountDetailsObj = JSON.parse(JSON.stringify(appliedDiscountDetailsObj));
                                                        if(j.weightUnit == "GMS" || j.weightUnit == "ML"  ){
                                                            lineWeight = j.productBasePrice*j.quantityOrdered*j.weight/1000
                                                        }
                                                        else{
                                                            lineWeight = j.productBasePrice*j.quantityOrdered*j.weight
                                                        }
                                                        discountValue =(billSchemeValue * eligibleAppliedDiscountLevel.discountValue/ 100);
                                                        // discountValue =parseFloat((billSchemeValue * eligibleAppliedDiscountLevel.discountValue/ 100).toFixed(3));
                                                        finalDiscountValue = (discountValue / totalValue * (lineWeight));
                                                        cDiscountDetailsObj['discountValue'] =  eligibleAppliedDiscountLevel.discountValue
                                                        cDiscountDetailsObj['discountPrice'] = parseFloat(finalDiscountValue.toFixed(3));
                                                        cDiscountDetailsObj['stprDiscountValue'] = parseFloat(finalDiscountValue.toFixed(3));
                                                        cDiscountDetailsObj['btprDiscountValue'] = 0
                                                        cDiscountDetailsObj['stprCashDiscountValue'] = 0
                                                        cDiscountDetailsObj['discountType'] = 'PERCENTAGE'
                                                        cDiscountDetailsObj['discountLevel'] = appliedDiscountLevel
                                                        cDiscountDetailsObj['discountProductMap'] = appliedDiscountProductMapping
                                                        
                                                        if(j.discounts){
                                                            j.discounts = j.discounts.filter(k=>k.discountID!=cDiscountDetailsObj.discountID)
                                                            j.discounts = [...(j.discounts),cDiscountDetailsObj]
                                                        }else{        
                                                            j['discounts'] = [cDiscountDetailsObj]
                                                        }
                                                        discntArry =   j.discounts
                                                        discSum = 0
                                                        stprDiscSum = 0
                                                        discntArry.map(v=>{
                                                            discSum += v.discountPrice
                                                            stprDiscSum += v.stprDiscountValue
                                                        })
                                                        j.discountValues = parseFloat(discSum.toFixed(3))
                                                        j.stprDiscountValues = parseFloat(stprDiscSum.toFixed(3))
                                                    })
                                                }
                                                else if(discountType == 'ABSOLUTE'){
                                                    applicableCartBatches.map((j)=>{
                                                        cDiscountDetailsObj = JSON.parse(JSON.stringify(appliedDiscountDetailsObj));
                                                        if(j.weightUnit == "GMS" || j.weightUnit == "ML" ){
                                                            lineWeight = j.productBasePrice*j.quantityOrdered*j.weight/1000
                                                        }
                                                        else{
                                                            lineWeight = j.productBasePrice*j.quantityOrdered*j.weight
                                                        }
                                                        console.log(lineWeight,'lineWeight')
                                                        var revereseTax = (j.totalTaxPercentage+100)/100
                                                        //var revereseTax = parseFloat(((j.totalTaxPercentage+100)/100)).toFixed(3)
                                                        discountValue = (billedQty * eligibleAppliedDiscountLevel.discountValue/ revereseTax)
                                                        //discountValue = parseFloat((billedQty * eligibleAppliedDiscountLevel.discountValue/ revereseTax).toFixed(3))
                                                        finalDiscountValue = (discountValue*lineWeight / cumBilledValue)
                        
                                                        cDiscountDetailsObj['discountValue'] =  eligibleAppliedDiscountLevel.discountValue
                                                        cDiscountDetailsObj['discountPrice'] = parseFloat(finalDiscountValue.toFixed(3))
                                                        cDiscountDetailsObj['stprDiscountValue'] = parseFloat(finalDiscountValue.toFixed(3))
                                                        cDiscountDetailsObj['btprDiscountValue'] = 0
                                                        cDiscountDetailsObj['stprCashDiscountValue'] = 0
                                                        cDiscountDetailsObj['discountType'] = 'ABSOLUTE'
                                                        cDiscountDetailsObj['discountLevel'] = appliedDiscountLevel
                                                        cDiscountDetailsObj['discountProductMap'] = appliedDiscountProductMapping
                    
                                                        if(j.discounts){
                                                            j.discounts = j.discounts.filter(k=>k.discountID!=cDiscountDetailsObj.discountID)
                                                            j.discounts = [...(j.discounts),cDiscountDetailsObj]
                                                        }else{        
                                                            j['discounts'] = [cDiscountDetailsObj]
                                                        }
                                                        discntArry =   j.discounts
                                                        discSum = 0
                                                        stprDiscSum = 0
                                                        discntArry.map(v=>{
                                                            discSum += v.discountPrice
                                                            stprDiscSum += v.stprDiscountValue
                                                        })
                                                        j.discountValues = parseFloat(discSum.toFixed(3))
                                                        j.stprDiscountValues = parseFloat(stprDiscSum.toFixed(3))
                                                    })
                        
                                                }
                                            }
                        
                        
                                            else if(discountSchemeBasis == 'VALUE'){
                                                var discountType = eligibleAppliedDiscountLevel.discountType
                        
                                                cumBilledQty = eligibleQuant;
                                                billedQty = parseInt(cumBilledQty/eligibleAppliedDiscountLevel.forEvery)
                        
                                                billedValue = eligibleValueByActualPrice;
                        
                                                billSchemeValue = (billedQty * eligibleAppliedDiscountLevel.forEvery * (billedValue / cumBilledQty))
                                                //billSchemeValue = parseFloat((billedQty * eligibleAppliedDiscountLevel.forEvery * (billedValue / cumBilledQty)).toFixed(3));
                                                
                                                if(discountType == 'PERCENTAGE'){
                                                    applicableCartBatches.map((j)=>{
                                                        cDiscountDetailsObj = JSON.parse(JSON.stringify(appliedDiscountDetailsObj)); 
                                                        var linePrice = j.productBasePrice*j.quantityOrdered;
                        
                                                        discountValue =(billSchemeValue * eligibleAppliedDiscountLevel.discountValue/ 100)
                                                        // discountValue =parseFloat((billSchemeValue * eligibleAppliedDiscountLevel.discountValue/ 100).toFixed(3));
                                                        finalDiscountValue = (discountValue / billedValue * (linePrice))
                                                        
                                                        cDiscountDetailsObj['discountValue'] =  eligibleAppliedDiscountLevel.discountValue
                                                        cDiscountDetailsObj['discountPrice'] =  parseFloat(finalDiscountValue.toFixed(3))
                                                        cDiscountDetailsObj['stprDiscountValue'] =  parseFloat(finalDiscountValue.toFixed(3))
                                                        cDiscountDetailsObj['btprDiscountValue'] = 0
                                                        cDiscountDetailsObj['stprCashDiscountValue'] = 0
                                                        cDiscountDetailsObj['discountType'] = 'PERCENTAGE'
                                                        cDiscountDetailsObj['discountLevel'] = appliedDiscountLevel
                                                        cDiscountDetailsObj['discountProductMap'] = appliedDiscountProductMapping
                                                        
                                                        if(j.discounts){
                                                            j.discounts = j.discounts.filter(k=>k.discountID!=cDiscountDetailsObj.discountID)
                                                            j.discounts = [...(j.discounts),cDiscountDetailsObj]
                                                        }else{        
                                                            j['discounts'] = [cDiscountDetailsObj]
                                                        }
                                                        discntArry =   j.discounts
                                                        discSum = 0
                                                        stprDiscSum = 0
                                                        discntArry.map(v=>{
                                                            discSum += v.discountPrice
                                                            stprDiscSum += v.stprDiscountValue
                                                        })
                                                        j.discountValues = parseFloat(discSum.toFixed(3))
                                                        j.stprDiscountValues = parseFloat(stprDiscSum.toFixed(3))
                                                    })
                                                }
                                                else if(discountType == 'ABSOLUTE'){
                                                    applicableCartBatches.map((j)=>{
                                                        cDiscountDetailsObj = JSON.parse(JSON.stringify(appliedDiscountDetailsObj));
                                                        var lineQuant =j.quantityOrdered
                                                        discountValue = (billedQty * eligibleAppliedDiscountLevel.discountValue)
                                                        //discountValue = parseFloat((billedQty * eligibleAppliedDiscountLevel.discountValue).toFixed(3))
                                                        finalDiscountValue = (discountValue*lineQuant / cumBilledQty)
                                                        //finalDiscountValue = parseFloat((discountValue*lineQuant / cumBilledQty).toFixed(3))
                
                                                        cDiscountDetailsObj['discountValue'] =  eligibleAppliedDiscountLevel.discountValue
                                                        cDiscountDetailsObj['discountPrice'] =   parseFloat(finalDiscountValue.toFixed(3))
                                                        cDiscountDetailsObj['stprDiscountValue'] =  parseFloat(finalDiscountValue.toFixed(3))
                                                        cDiscountDetailsObj['btprDiscountValue'] = 0
                                                        cDiscountDetailsObj['stprCashDiscountValue'] = 0
                                                        cDiscountDetailsObj['discountType'] = 'ABSOLUTE'
                                                        cDiscountDetailsObj['discountLevel'] = appliedDiscountLevel
                                                        cDiscountDetailsObj['discountProductMap'] = appliedDiscountProductMapping

                                                        if(j.discounts){
                                                            j.discounts = j.discounts.filter(k=>k.discountID!=cDiscountDetailsObj.discountID)
                                                            j.discounts = [...(j.discounts),cDiscountDetailsObj]
                                                        }else{        
                                                            j['discounts'] = [cDiscountDetailsObj]
                                                        }
                                                        discntArry =   j.discounts
                                                        discSum = 0
                                                        stprDiscSum = 0
                                                        discntArry.map(v=>{
                                                            discSum += v.discountPrice
                                                            stprDiscSum += v.stprDiscountValue
                                                        })
                                                        j.discountValues = parseFloat(discSum.toFixed(3))
                                                        j.stprDiscountValues = parseFloat(stprDiscSum.toFixed(3))
                                                    })
                        
                                                }
                                            }
                        
                                            else if(discountSchemeBasis == 'UNIT'){
                                                var discountType = eligibleAppliedDiscountLevel.discountType
                        
                                                cumBilledQty = eligibleQuant;
                                                billedQty = parseInt(cumBilledQty/eligibleAppliedDiscountLevel.forEvery)
                        
                                                billedValue = eligibleValue;
                        
                                                billSchemeValue = (billedQty * eligibleAppliedDiscountLevel.forEvery * (billedValue / cumBilledQty))
                                                //billSchemeValue = parseFloat((billedQty * eligibleAppliedDiscountLevel.forEvery * (billedValue / cumBilledQty)).toFixed(3));
                                                
                                                if(discountType == 'PERCENTAGE'){
                                                    applicableCartBatches.map((j)=>{
                                                        cDiscountDetailsObj = JSON.parse(JSON.stringify(appliedDiscountDetailsObj));
                                                        var linePrice = j.productBasePrice*j.quantityOrdered
                                                        //discountValue =parseFloat((billSchemeValue * eligibleAppliedDiscountLevel.discountValue/ 100).toFixed(3));
                                                        discountValue =(billSchemeValue * eligibleAppliedDiscountLevel.discountValue/ 100)
                
                                                        finalDiscountValue = (discountValue / billedValue * (linePrice))
                                                        cDiscountDetailsObj['discountValue'] =  eligibleAppliedDiscountLevel.discountValue
                                                        cDiscountDetailsObj['discountPrice'] =    parseFloat(finalDiscountValue.toFixed(3))
                                                        cDiscountDetailsObj['stprDiscountValue'] =    parseFloat(finalDiscountValue.toFixed(3))
                                                        cDiscountDetailsObj['btprDiscountValue'] = 0
                                                        cDiscountDetailsObj['stprCashDiscountValue'] = 0
                                                        cDiscountDetailsObj['discountType'] = 'PERCENTAGE'
                                                        cDiscountDetailsObj['discountLevel'] = appliedDiscountLevel
                                                        cDiscountDetailsObj['discountProductMap'] = appliedDiscountProductMapping

                                                        if(j.discounts){
                                                            j.discounts = j.discounts.filter(k=>k.discountID!=cDiscountDetailsObj.discountID)
                                                            j.discounts = [...(j.discounts),cDiscountDetailsObj]
                                                        }else{        
                                                            j['discounts'] = [cDiscountDetailsObj]
                                                        }
                                                        discntArry =   j.discounts
                                                        discSum = 0
                                                        stprDiscSum = 0
                                                        discntArry.map(v=>{
                                                            discSum += v.discountPrice
                                                            stprDiscSum += v.stprDiscountValue
                                                        })
                                                        j.discountValues = parseFloat(discSum.toFixed(3))
                                                        j.stprDiscountValues = parseFloat(stprDiscSum.toFixed(3))
                                                    })
                                                }
                                                else if(discountType == 'ABSOLUTE'){
                                                    applicableCartBatches.map((j)=>{
                                                        cDiscountDetailsObj = JSON.parse(JSON.stringify(appliedDiscountDetailsObj));
                                                        var lineQuant =j.quantityOrdered
                                                        var revereseTax = (j.totalTaxPercentage+100)/100;
                                                        //var revereseTax = parseFloat(((j.totalTaxPercentage+100)/100)).toFixed(3)
                                                        discountValue = (billedQty * eligibleAppliedDiscountLevel.discountValue/ revereseTax)
                                                        //discountValue = parseFloat((billedQty * eligibleAppliedDiscountLevel.discountValue/ revereseTax).toFixed(3))
                                                        finalDiscountValue = (discountValue*lineQuant / cumBilledQty)
                                                        //finalDiscountValue = parseFloat((discountValue*lineQuant / cumBilledQty).toFixed(3))
                                                        
                                                        cDiscountDetailsObj['discountValue'] =  eligibleAppliedDiscountLevel.discountValue
                                                        cDiscountDetailsObj['discountPrice'] = parseFloat(finalDiscountValue.toFixed(3))
                                                        cDiscountDetailsObj['stprDiscountValue'] = parseFloat(finalDiscountValue.toFixed(3))
                                                        cDiscountDetailsObj['btprDiscountValue'] = 0
                                                        cDiscountDetailsObj['stprCashDiscountValue'] = 0
                                                        cDiscountDetailsObj['discountType'] = 'ABSOLUTE'
                                                        cDiscountDetailsObj['discountLevel'] = appliedDiscountLevel
                                                        cDiscountDetailsObj['discountProductMap'] = appliedDiscountProductMapping
                                                        
                                                        if(j.discounts){
                                                            j.discounts = j.discounts.filter(k=>k.discountID!=cDiscountDetailsObj.discountID)
                                                            j.discounts = [...(j.discounts),cDiscountDetailsObj]
                                                        }else{        
                                                            j['discounts'] = [cDiscountDetailsObj]
                                                        }
                                                        discntArry =   j.discounts
                                                        discSum = 0
                                                        stprDiscSum = 0
                                                        discntArry.map(v=>{
                                                            discSum += v.discountPrice
                                                            stprDiscSum += v.stprDiscountValue
                                                        })
                                                        j.discountValues = parseFloat(discSum.toFixed(3));
                                                        j.stprDiscountValues = parseFloat(stprDiscSum.toFixed(3));
                                                    })
                        
                                                }
                                            }
                                        }
                                        else{
                                            applicableCartBatches.map((l)=>{ 
                                                cDiscountDetailsObj = JSON.parse(JSON.stringify(appliedDiscountDetailsObj));
                                                if(l.discounts){
                                                    l.discounts = l.discounts.filter(m=>m.discountID!=cDiscountDetailsObj.discountID)     
                                                }
                                                else{
                                                    l['discounts'] = []
                                                }
                                                l['discountValues'] = 0
                                                l['stprDiscountValues'] = 0
                                                l['btprDiscountValues'] = 0
                                                l['stprCashDiscountValue'] = 0
                                            })          
                                        }
                                    }
                                }
                            }
                        // else{
                        //         applicableCartBatches.map((l)=>{ 
                        //             cDiscountDetailsObj = JSON.parse(JSON.stringify(appliedDiscountDetailsObj));
                        //             if(l.discounts){
                        //                 l.discounts = l.discounts.filter(m=>m.discountID!=cDiscountDetailsObj.discountID)     
                        //             }
                        //             else{
                        //                 l['discounts'] = []
                        //             }
                        //             l['discountValues'] = 0
                        //             l['stprDiscountValues'] = 0
                        //             l['btprDiscountValues'] = 0
                        //             l['stprCashDiscountValue'] = 0
                        //         })          
                        //     }
                        }
                    })
                })

                console.log(cartBatchDataWithSchemes,'cartBatchDataWithSchemes')
                if(cashDiscArray.length){
                    var cartBatchDataWithCashSchemes =  handleCashDiscount(cartBatchDataWithSchemes,cashDiscArray)
                    return cartBatchDataWithCashSchemes
                }
                return cartBatchDataWithSchemes
            }

            handleCashDiscount=(cartBatchDataWithSchemes,cashDiscArray)=>{
                var filteredCartBatchDataWithSchemes=cartBatchDataWithSchemes.filter(z=> z.quantityOrdered>0 && z.sbomDesc != "LSBOM-C")

                filteredCartBatchDataWithSchemes.map((a)=>{
                    a['cashBasePrice'] = (a.productBasePrice)-(a.stprDiscountValues/a.quantityOrdered)
  
                    cashDiscArray.map(b=>{
                        if(b.discountType=="PERCENTAGE"){
                            cCashDiscountObj = JSON.parse(JSON.stringify(b)); 
                            cashDiscPercent = cCashDiscountObj.discountValue;       
                            cCashDiscountObj['discountPrice'] =  parseFloat(((a.cashBasePrice*cCashDiscountObj.discountValue)/100 * a.quantityOrdered).toFixed(3)) 
                            cCashDiscountObj['stprCashDiscountValue'] =  parseFloat(((a.cashBasePrice*cCashDiscountObj.discountValue)/100 * a.quantityOrdered).toFixed(3)) 
                            cCashDiscountObj['stprDiscountValue'] = 0
                            cCashDiscountObj['btprDiscountValue'] = 0
                            if(a.discounts){
                                a.discounts = a.discounts.filter(k=>k.discountID!=b.discountID)
                                a.discounts = [...(a.discounts),cCashDiscountObj]
                            }else{        
                                a['discounts'] = [cCashDiscountObj]
                            }
                        } 
                        if(b.discountType=="ABSOLUTE"){
                            cCashDiscountObj = JSON.parse(JSON.stringify(b));  
                            cashDiscPercent = cCashDiscountObj.discountValue;      
                            cCashDiscountObj['discountPrice'] =  parseFloat((cCashDiscountObj.discountValue * a.quantityOrdered).toFixed(3)) 
                            cCashDiscountObj['stprCashDiscountValue'] =  parseFloat((cCashDiscountObj.discountValue * a.quantityOrdered).toFixed(3))  
                            cCashDiscountObj['stprDiscountValue'] =  0;
                            cCashDiscountObj['btprDiscountValue'] = 0; 
                            if(a.discounts){
                                a.discounts = a.discounts.filter(k=>k.discountID!=b.discountID)
                                a.discounts = [...(a.discounts),cCashDiscountObj]
                            }else{        
                                a['discounts'] = [cCashDiscountObj]
                            }
                        } 
                    })
                    discntArry =   a.discounts
                    discSum = 0
                    stprDiscSum = 0
                    discntArry.map(v=>{
                        discSum += v.discountPrice
                        stprDiscSum += v.stprCashDiscountValue
                    })
                    a.discountValues = parseFloat(discSum.toFixed(3))
                    a.stprCashDiscountValues = parseFloat(stprDiscSum.toFixed(3))
                })
                return cartBatchDataWithSchemes
            }

            function handleChildProductBatchToCart(m){
            
                var temp = [];

                if(m.sbomDesc == "LSBOM-P" && m.quantityOrdered>=m.parentSkuQty){

                    var i = Math.floor(m.quantityOrdered/m.parentSkuQty);
                    var maxUnitLimit = i*m.childSkuQty;

                    var data = childBatches.filter(child=>child.serialNumber == m.cpLinkage && child.currentInventory>0);
    
                    if(data.length == 0){
                        return;
                    }

                    data.sort(function(a,b){
                        return new Date(a.manufacturingDate) - new Date(b.manufacturingDate);
                    });

                    console.log(m.cpLinkage,maxUnitLimit)

                    data.map(n=>{

                        if(maxUnitLimit == 0){
                            return;
                        }

                        if(maxUnitLimit>n.currentInventory){
                            n.quantityOrdered = n.inventory;
                            n.totalQuantityOrdered += n.inventory;
                            n.currentInventory = 0;
                            maxUnitLimit = maxUnitLimit-n.inventory;
                        }
                        else{
                            n.quantityOrdered = maxUnitLimit;
                            n.totalQuantityOrdered += maxUnitLimit
                            n.currentInventory = n.currentInventory - maxUnitLimit;
                            maxUnitLimit = 0;
                        }
                    })

                    data.map(n=>{

                        if(n.totalQuantityOrdered > 0){
                            var x = $.extend(true,{},n);
                            temp.push(x);
                        }
                    })

                    console.log(temp)
                }

                return temp;
            }

            async function applyCreditNotes(customerID,grossSale){

                var credits =  await new Promise((resolve,reject)=>{

                    db.all(`SELECT DISTINCT creditNoteID,amount from creditNotes WHERE customerID = ${customerID} AND isActive = 1 GROUP BY creditNoteID ORDER BY amount`,function(err,data){

                        if(err){
                            console.log(err)
                        }
                        else{
                            resolve(data);
                        }
                    })
                })

                var totalSum = 0;

                for(let i=0;i<credits.length;i++)
                {
                    credits[i].amount = parseInt(credits[i].amount);
                    totalSum += credits[i].amount;
                }

                credits = credits.sort(function(a,b){
                    return a.amount - b.amount;
                })                
                
                // console.log('grossSale',grossSale)

                var sum = 0;
                var endIndex = -1;

                for(let i=0;i<credits.length;i++)
                {
                    sum += credits[i].amount;

                    if(sum > grossSale){
                        sum -= credits[i].amount;
                        endIndex = i - 1;
                        break;   
                    }

                    if(i == credits.length - 1){
                        endIndex = i;
                    }
                }

                var cash = grossSale - sum;
                cash = Math.round(cash*100)/100;

                // console.log('credit sum',sum)
                // console.log('cash',cash)

                payableAmnt = cash;
                creditNotesAdjust = sum;

                if(cash == 0){
                    var temp = [];
                }
                else{
                    var temp = [{paymentType:'PAYMENT_CASH',amount:cash}];
                }
                
                if(endIndex != -1){

                    for(let i=0;i<=endIndex;i++)
                    {
                        temp.push({paymentType:'PAYMENT_CREDIT_NOTE',creditNoteID:credits[i].creditNoteID,amount:credits[i].amount});
                    }
                }
               
               
                var cashAccountID = await new Promise((resolve,reject)=>{

                    db.get(`SELECT * FROM globalTypePaymentAccountIDMapping WHERE key = "PAYMENT_CASH"`,function(err,data){

                        if(err){
                            console.log(err)
                        }
                        else{
                            resolve(data.accountID);
                        }
                    })
                })

                var cashAccountInfo = await new Promise((resolve,reject)=>{

                    db.get(`SELECT * FROM accountInformation where accountID = ${cashAccountID}`,function(err,data){

                        if(err){
                            console.log(err)
                        }
                        else{
                            resolve(data);
                        }
                    })
                })

                var creditAccountID = await new Promise((resolve,reject)=>{

                    db.get(`SELECT * FROM globalTypePaymentAccountIDMapping WHERE key = "PAYMENT_CREDIT_NOTE"`,function(err,data){

                        if(err){
                            console.log(err)
                        }
                        else{
                            resolve(data.accountID);
                        }
                    })
                })

                var creditAccountInfo = await new Promise((resolve,reject)=>{

                    db.get(`SELECT * FROM accountInformation where accountID = ${creditAccountID}`,function(err,data){

                        if(err){
                            console.log(err)
                        }
                        else{
                            resolve(data);
                        }
                    })
                })

                // console.log(cashAccountID,cashAccountInfo,creditAccountID,creditAccountInfo)

                for(let i=0;i<temp.length;i++)
                {
                    
                    if(temp[i].paymentType == 'PAYMENT_CASH'){

                        paymentGenerator(cashAccountInfo,temp[i],i)   
                    }
                    else if(temp[i].paymentType == 'PAYMENT_CREDIT_NOTE'){

                        paymentGenerator(creditAccountInfo,temp[i],i);
                    }                    
                }

                // console.log(temp)
                return temp;
            }

            function paymentGenerator(account,temp,i){
               
                temp.accountId = account.accountID;
                temp.accountName = account.accountName;
                temp.accountType = account.accountType;
                temp.acquiringBankCode = "";
                // temp.amount = temp.amount;
                temp.approvalCode = "";
                temp.cardHolderName = "";
                temp.cardType = "";
                temp.expDate = "";
                temp.lastFourDigits = "";
                temp.newAmount = 0.0;
                temp.orderTimeLocal = "";
                temp.partType = "";
                temp.partyID = -1;
                temp.partyName = "";
                temp.paymentSubID = i + 1;
                temp.paymentTerminal = "";
                // temp.paymentType = "PAYMENT_CASH";
                temp.posDate = "";
                temp.transactionID = "";
                temp.transactionType = "TRN_ORDER";
                temp.userID = -1;
                temp.changeAmount = "";
                temp.tenderedAmount = "";
                temp.shortAmount = "";
                temp.tenderedAmountCurrency = "";
                temp.tenderedAmountCurrencyCF = "";
                temp.referenceId = ""
            }

            async function productToChildBatchMapper(childList){

                for(let i=0;i<childList.length;i++)
                {
                    var x = await new Promise((resolve,reject)=>{

                        db.get(`SELECT A.*,B.* FROM batchProductVariants AS A INNER JOIN products AS B ON A.productID = B.productID WHERE A.batchVariantID = ${childList[i].batchVariantID}`,function(error,data){

                            if(error){
                                console.log(error)
                            }
                            else{
                                // console.log(data)
                                resolve(data);
                            }
                        })
                    })
                    
                    var quantityOrdered = childList[i].quantityOrdered;
                    childList[i] = x;
                    childList[i].quantityOrdered = quantityOrdered;
                    childList[i].quantityOrderedCost = 0;
                    childList[i].taxableValue = 0;
                    childList[i].totalTaxValue = 0;
                    childList[i].productValue = 0;
                    childList[i].itemSales = 0;
                    childList[i].taxes = [];
                    childList[i].discountTotalValue = 0;
                    childList[i].turPerUnit = 0;
                    childList[i].discounts = [];
                    childList[i].discountValues = 0;
                    childList[i].totalTaxPercentage = 0;
                    childList[i].productBasePrice = 0;
                }

            }

            function compareDate(currentDate,createdOnUTC)
            {

                currentYear = parseInt(currentDate.slice(0,4));
                currentMonth = parseInt(currentDate.slice(5,7));
                currentDay = parseInt(currentDate.slice(8,10));

                year = parseInt(createdOnUTC.slice(0,4));
                month = parseInt(createdOnUTC.slice(5,7));
                day = parseInt(createdOnUTC.slice(8,10));

                if(currentYear > year){
                    return true;
                }
                else if(currentMonth > month){
                    return true;
                }
                else if((currentDay - day) > 2){
                   return true;
                }
                else return false;
            }

            function deleteMarketOrder(element){

                var id = element.id;
                id = id.substr(7,id.length);
                deleteOrderID = id;

                console.log('deleteOrderID',deleteOrderID)

                $('#deleteOrderModal').modal('show');
            }

            async function finalDeleteOrder(){

                var d = new Date();
                var date = d.toISOString().slice(0,10);

                var operationTime = date;
                var fieldInformation = {
                    proformaInvoiceID : deleteOrderID,
                    storeID : loginResponse.storeList[0].storeID,
                    status : 'REJECTED'
                }

                console.log('finalDeleteOrder',deleteOrderID)
                console.log('operationTime',operationTime)
                console.log('fieldInformation',fieldInformation)

                fieldInformation = JSON.stringify(fieldInformation);
                
                await new Promise((resolve,reject)=>{

                    db.run(`INSERT INTO catalogueSyncTable (fieldID, fieldURL, isSync, logID, tableName, operationTime, operations, fieldInformation) VALUES 
                            ('${deleteOrderID}','http://13.235.5.156/ssapi/public/v1/merchant/1/updatePIStatus',0,'${deleteOrderID}','comboGroups','${operationTime}','insert','${fieldInformation}')`,function(err,data){

                        if(err){
                            console.log(err)
                        }
                        else{
                            resolve();
                        }
                    })

                })

                await new Promise((resolve,reject)=>{

                    db.run(`DELETE FROM piSummary WHERE proformaInvoiceID = '${deleteOrderID}'`,function(err,data){

                        if(err){
                            console.log(err)
                        }
                        else{
                            resolve();
                        }
                    })
                
                })

                window.location.href = './pendingPIList.html';                

            }

            async function loadPIList(){
                

                getPendingPICount();

                userID = loginResponse.userID;

                outletList = await new Promise((resolve,reject) => {
                    
                    db.all('SELECT * from piSummary WHERE status = "RECEIVED" ',function(error,rows){

                        if(error){
                            console.log(error);
                        }
                        else{
                            // console.log(rows)
                            for(let i=0;i<rows.length;i++)
                            {
                                rows[i].json = JSON.parse(rows[i].json)
                            }
                            resolve(rows);
                        }
                    })
                })

                console.log('outletList ',outletList);

                var d = new Date();
                var currentDate = d.toISOString().slice(0,10).toString();
                var x,createdOnUTC,diff;

                for(let i=0;i<outletList.length;i++)
                {
                    createdOnUTC = outletList[i].json.PISummary[0].posDate;
                    outletList[i].createdOnUTC = createdOnUTC;
                    outletList[i].deleteOrder = compareDate(currentDate,createdOnUTC);
                }

                // return false;

                if(outletList.length == 0){

                    $('#pendingOrdersSection').css('display','none');
                    $('#noOrdersSection').css('display','flex');
                    return false;
                }

                account = await new Promise((resolve,reject)=>{
            
                    db.get(`select * from accountInformation where accountID = ${accountId}`,function(error,data){
                        if(error){
                            console.log(error)
                        }
                        else{
                            resolve(data);
                        }
                    })
                })

                // console.log(account);
                
                userName = await new Promise((resolve,reject)=>{

                    db.get(`SELECT username from users WHERE id = ${userID}`,function(error,data){
                
                        if(error){
                            console.log(error)
                        }
                        else{
                            console.log(data)
                            resolve(data.userName)
                        }
                    });

                })

                mocs = await new Promise((resolve,reject)=>{

                    db.get('SELECT * FROM MOCS',function(error,data){
                        
                        if(error){
                            console.log(error)
                        }
                        else{
                            resolve(data)
                        }
                    })
                })

                // console.log('mocs ',mocs)

                allProductsList = await new Promise((resolve,reject) => {

                    db.all('SELECT * from products',function(error,rows){
                        if(error){
                            console.log(error);
                        }
                        else{
                            resolve(rows);
                        }
                    })
                })

                // console.log('allProductsList ',allProductsList)

                batchVariant = await new Promise((resolve,reject)=>{

                    db.all('SELECT batchProductVariants.*,storeRegion.turPerUnit from batchProductVariants INNER JOIN storeRegion ON batchProductVariants.serialNumber = storeRegion.sku WHERE batchProductVariants.inventory > 0 AND batchProductVariants.sbomDesc != "LSBOM-C"',function(error,rows){
                        if(error){
                            console.log(error)
                        }
                        else{
                            resolve(rows);
                        }
                    })
                })
                

                for(let i=0;i<outletList.length;i++)
                {
                    id = outletList[i].json.PISummary[0].proformaInvoiceID;
                    storeName = outletList[i].json.customerInfo[0].firstName;
                    grossBill = outletList[i].json.PISummary[0].grossBill;
                    quantityOrdered = outletList[i].json.PIDetail.length;
                    externalOrderID = outletList[i].json.PISummary[0].externalOrderID;
                    posDate = outletList[i].json.PISummary[0].posDate;
                    var date = new Date(posDate).toUTCString();
                    date = date.substr(0,date.length - 12);
                    deleteOrder = outletList[i].deleteOrder;
                    
                    // $('#outletList').append('<div id='+id+' onclick="outletOrder(this)" style="padding:10px; border-bottom:solid 1px #eff1f3"><div><span class="text_14_500_565656">'+date+'</span></div><div style="display:flex; flex-direction:row; align-items:center"><input id=checkbox'+id+' type="checkbox" onclick="calculateStock()"/><span style="padding-left:10px">'+storeName+'</span></div><div style="display:flex; flex-direction:row; justify-content:space-between;"><span style="margin-left:20px;" class="text_14_500_565656">Total Items : '+quantityOrdered+'</span><span class="text_16_500_565656">&#8377; '+grossBill+'</span></div><div>Order No. '+externalOrderID+'</div></div>');
                    
                    if(deleteOrder){
                        $('#outletList').append(`<div id=${id} onclick="outletOrder(this)" style="padding:10px; border-bottom:solid 1px #eff1f3">
                                                    <div class="flex-row" style="justify-content:space-between">
                                                        <span class="text_14_500_565656">${date}</span>
                                                        <div style="cursor: pointer;" id="delete-${id}" onclick = "deleteMarketOrder(this)"><img src = "../../assets/img/trash-gray.png"></div>
                                                    </div>
                                                    <div style="display:flex; flex-direction:row; align-items:center">
                                                        <input id="checkbox${id}" type="checkbox" onclick="calculateStock()"/>
                                                        <span style="padding-left:10px">${storeName}</span>
                                                    </div>
                                                    <div style="display:flex; flex-direction:row; justify-content:space-between;">
                                                        <span style="margin-left:20px;" class="text_14_500_565656">Total Items : ${quantityOrdered}</span>
                                                        <span class="text_16_500_565656">&#8377; ${grossBill}</span>
                                                    </div>
                                                    <div>Order No. ${externalOrderID}</div>
                                                </div>`);
                    }
                    else{
                        $('#outletList').append(`<div id=${id} onclick="outletOrder(this)" style="padding:10px; border-bottom:solid 1px #eff1f3">
                                                    <div>
                                                        <span class="text_14_500_565656">${date}</span>
                                                    </div>
                                                    <div style="display:flex; flex-direction:row; align-items:center">
                                                        <input id="checkbox${id}" type="checkbox" onclick="calculateStock()"/>
                                                        <span style="padding-left:10px">${storeName}</span>
                                                    </div>
                                                    <div style="display:flex; flex-direction:row; justify-content:space-between;">
                                                        <span style="margin-left:20px;" class="text_14_500_565656">Total Items : ${quantityOrdered}</span>
                                                        <span class="text_16_500_565656">&#8377; ${grossBill}</span>
                                                    </div>
                                                    <div>Order No. ${externalOrderID}</div>
                                                </div>`);
                    }
                } 
               
                // new code for units case and inventory level display

                for(let i=0;i<outletList.length;i++)
                {
                    var products = outletList[i].json.PIDetail;
                    var prodList = "";

                    for(let j=0;j<products.length;j++)
                    {
                        prodList += products[j].productID+',';
                    }

                    prodList = prodList.substr(0,prodList.length - 1);
                    // console.log(prodList);

                    var dataList = await new Promise((resolve,reject)=>{

                        db.all(`SELECT DISTINCT A.productID,B.unitsPerCase,SUM(A.inventory) AS closingStock FROM batchProductVariants AS A INNER JOIN products AS B ON A.productID = B.productID WHERE A.sbomDesc != "LSBOM-C" AND A.productID IN (${prodList}) GROUP BY A.productID ORDER BY A.productID;`,function(err,data){

                            if(err){
                                console.log(err)
                            }
                            else{
                                // console.log(data)
                                resolve(data)
                            }
                        })
                    })

                    for(let j=0;j<products.length;j++)
                    {
                        for(let k=0;k<dataList.length;k++)
                        {
                            if(products[j].productID == dataList[k].productID){

                                // products[j].closingStock = dataList[k].closingStock;
                                products[j].unitsPerCase = dataList[k].unitsPerCase;
                                break;
                            }
                        }
                    }

                    for(let j=0;j<products.length;j++)
                    {
                        var sum = 0;
                        for(let k=0;k<batchVariant.length;k++)
                        {
                            if(products[j].productID == batchVariant[k].productID)
                            {
                                sum += batchVariant[k].inventory;
                            }
                        }
                        products[j].closingStock = sum;
                    }

                }

                //  ends here

                    $('#headerStore').text(outletList[0].json.customerInfo[0].firstName);
                    $('#headerPrice').html(outletList[0].json.PISummary[0].grossBill);
                    $('#headerItems').text(outletList[0].json.PIDetail.length);
                    $('#orderDetail').bootstrapTable('destroy');
                    $('#orderDetail').bootstrapTable({data:outletList[0].json.PIDetail,
                                                    search:false,
                                                    reinit: true,
                                                    trimOnSearch:false
                });
                
                $('#orderDetailSection').css('display','block');      

                taxList = await new Promise((resolve,reject)=>{

                    db.all('SELECT * FROM taxes',function(error,rows){
                        if(error){
                            console.log(error)
                        }
                        else{
                            resolve(rows);
                        }
                    })
                })

                // console.log('taxes ',taxList)

                discountAppliedIDs = await new Promise((resolve,reject)=>{
                    db.all(`SELECT discountID,customerID FROM discountCustomerMap `,(err,data)=>{

                        if(err){
                            console.log(err)
                        }
                        else{
                            // console.log(data)
                            resolve(data)
                        }
                    });
                })
                // console.log(discountAppliedIDs,'discountAppliedIDs')

                discountProductList  = await new Promise((resolve,reject)=>{
                    db.all(`SELECT * FROM discountProductMap`,(err,data)=>{

                        if(err){
                            console.log(err)
                        }
                        else{
                            // console.log(data)
                            resolve(data)
                        }
                    });
                })

                discountLevelList = await new Promise((resolve,reject)=>{
                    db.all(`SELECT * FROM discountLevel`,(err,data)=>{

                        if(err){
                            console.log(err)
                        }
                        else{
                            // console.log(data)
                            resolve(data)
                        }
                    });
                })

                discountDetails = await new Promise((resolve,reject)=>{
                    db.all(`SELECT * FROM discountMaster`,(err,data)=>{

                        if(err){
                            console.log(err)
                        }
                        else{
                            // console.log(data)
                            resolve(data)
                        }
                    });
                })
               
                discountClusters = await new Promise((resolve,reject)=>{
                    db.all(`SELECT * FROM discountClusters`,(err,data)=>{
                        if(err){
                            console.log(err);
                        }
                        else{
                            // console.log(data)
                            resolve(data)
                        }
                    })
                })

                for(let i=0;i<batchVariant.length;i++)
                {
                    for(let j=0;j<allProductsList.length;j++)
                    {
                        if(batchVariant[i].productID == allProductsList[j].productID)
                        {
                            taxArr = allProductsList[j].taxIDs.split(',');
                            batchVariant[i].taxArr = taxArr;
                            break;
                        }
                    }
                }

                // console.log('batchesVariants ',batchVariant)

                for(let i=0;i<batchVariant.length;i++)
                {
                    batchVariant[i].taxes = [];
                    
                    if(batchVariant[i].taxArr !== undefined){
                    
                        for(let j=0;j<batchVariant[i].taxArr.length;j++)
                        {
                            taxID = batchVariant[i].taxArr[j];

                            for(let k=0;k<taxList.length;k++)
                            {
                                if(taxID == taxList[k].taxID)
                                {
                                    var x = $.extend(true,{},taxList[k]);
                                    batchVariant[i].taxes[j] = x;
                                    break;
                                }
                            }
                        }

                    }
                    else{
                        console.log(i)
                    }
                }


            }

            function outletOrder(element){

                let id;
                let proformaInvoiceID = element.id;
                
                console.log(proformaInvoiceID)
 
                for(let i=0;i<outletList.length;i++)
                {
                    id = outletList[i].json.PISummary[0].proformaInvoiceID;
                    id = '#'+id;
                    $(id).css('background','#fff')
                }

                id = '#'+proformaInvoiceID;
                $(id).css('background','#ddddddab');

                for(let i=0;i<outletList.length;i++)
                {

                    if(proformaInvoiceID == outletList[i].json.PISummary[0].proformaInvoiceID)
                    {
                        console.log(outletList[i])
                        $('#headerStore').text(outletList[i].json.customerInfo[0].firstName);
                        $('#headerPrice').html(outletList[i].json.PISummary[0].grossBill);
                        $('#headerItems').text(outletList[i].json.PIDetail.length);
                        $('#orderDetail').bootstrapTable('destroy');
                        $('#orderDetail').bootstrapTable({data:outletList[i].json.PIDetail,
                                                        search:false,
                                                        reinit: true,
                                                        trimOnSearch:false
                        });
                        break;
                    }
                }
                
            }

            function chosenOutletOrder(element){

                let proformaInvoiceID = element.id;
                let actualID = proformaInvoiceID.substr(7,proformaInvoiceID.length);
                console.log(actualID)
                
                let tableID = '#table-'+actualID;
 
                for(let i=0;i<cart.length;i++)
                {
                    if(cart[i].proformaID != actualID)
                    {
                        $('#table-'+cart[i].proformaID).css('display','none');
                        $('#chosen-'+cart[i].proformaID).css('background','#fff');
                    }
                }
                
                $(tableID).css('display','block');
                id = '#'+proformaInvoiceID;
                $(id).css('background','#ddddddab');
            }

            function calculateStock(){

                proformaArray = [];
                let input = $('input[type="checkbox"]')
                totalStockValue = 0;
                totalStockItems = 0;

                for(let i=0;i<input.length;i++)
                {
                   
                    let id = input[i].id;
                    proformaInvoiceID = id.substr(0,8);
                    
                    if(proformaInvoiceID == "checkbox" && input[i].checked){

                        actualID = id.substr(8,id.length);
                        proformaArray.push(actualID)
                    }
                }

                for(let i=0;i<proformaArray.length;i++)
                {
                    for(let j=0; j<outletList.length;j++)
                    {
                        if(proformaArray[i] == outletList[j].json.PISummary[0].proformaInvoiceID)
                        {
                            totalStockValue += outletList[j].json.PISummary[0].grossBill;
                            totalStockItems += outletList[j].json.PIDetail.length;
                            break;
                        }
                    }
                }

                totalStockValue = Math.round(totalStockValue);
                $('#totalSection').css('display','flex');
                $('#totalStockValue').text(totalStockValue);
                $('#totalStockItems').text(totalStockItems)
            }

            async function stockAllocation(){

                // console.log(proformaArray)
                let id,productID,orderedQuantity,found,products = [],piList=[],batchVariantCopy;

                stockProducts = [];
                cart = [];

                // creating pi list for each productID

                if(proformaArray.length == 0){

                    var dialogOptions = {type: 'info', buttons: ['OK'], message: 'Please Select Orders'}
                
                    dialog.showMessageBox(dialogOptions, async i => {
                        
                    })       

                }   

                for(let i=0;i<proformaArray.length;i++)
                {
                    let proformaID = proformaArray[i];

                    for(let j=0; j<outletList.length;j++)
                    {
                        if(proformaID == outletList[j].json.PISummary[0].proformaInvoiceID)
                        {
                           products = outletList[j].json.PIDetail;
                           grossBill = outletList[j].json.PISummary[0].grossBill;
                           firstName = outletList[j].json.customerInfo[0].firstName;
                           externalOrderID = outletList[j].json.PISummary[0].externalOrderID;

                           cart.push({products,proformaID,grossBill,firstName,externalOrderID});

                           for(let i=0;i<products.length;i++)
                           {

                                productID = JSON.stringify(products[i].productID);
                                if(stockProducts[JSON.stringify(productID)] !== undefined)
                                {
                                    stockProducts[JSON.stringify(productID)].quantityOrdered += products[i].quantityOrdered; 
                                    stockProducts[JSON.stringify(productID)].piList.push({proformaID,quantityOrdered:products[i].quantityOrdered})
                                }
                                else{
                                    stockProducts[JSON.stringify(productID)] = {};
                                    stockProducts[JSON.stringify(productID)].productID = products[i].productID;
                                    stockProducts[JSON.stringify(productID)].productName = products[i].productName;
                                    stockProducts[JSON.stringify(productID)].quantityOrdered = products[i].quantityOrdered;
                                    stockProducts[JSON.stringify(productID)].piList = [];
                                    stockProducts[JSON.stringify(productID)].piList.push({proformaID,quantityOrdered:products[i].quantityOrdered})
                                }
                           }
                           break;
                        }
                    }
                }

                // assigning the whole product object 

                // for(let productID in stockProducts)
                // {
                //     orderedQuantity = stockProducts[productID].quantityOrdered;
                //     piList = stockProducts[productID].piList;
                //     found = false;

                //     for(let i=0; i<allProductsList.length; i++)
                //     {
                //         x = JSON.stringify(allProductsList[i].productID);

                //         if(productID == x)
                //         {
                //             // stockProducts[productID] = allProductsList[i];
                //             stockProducts[productID].quantityOrdered = orderedQuantity;
                //             stockProducts[productID].piList = piList;
                //             found = true;
                //             break;
                //         }
                //     }

                //     if(!found)
                //     {
                //         delete stockProducts[productID];
                //     }
                // }

                // assigning inventory to products from batches using productID

                for(let productID in stockProducts)
                {
                    var x = stockProducts[productID].productID;

                    // await new Promise((resolve,reject)=>{

                    //     db.get(`select sum(inventory) as inventory from batchproductvariants where productID = ${x}`,function(error,sum){
                            
                    //         if(error){
                    //             console.log(error)
                    //         }
                    //         else{
                    //             stockProducts[productID].inventoryAmount = sum.inventory
                    //             resolve();
                    //         }
                    //     })

                    // })

                    var sum = 0;

                    for(let i=0;i<batchVariant.length;i++)
                    {
                        if(x == batchVariant[i].productID)
                        {
                            sum += batchVariant[i].inventory;
                        }
                    }

                    stockProducts[productID].inventoryAmount = sum;
                }
                
                // assigning the quantity to each product in orders list

                for(let productID in stockProducts)
                {
                    stockProducts[productID].quantityAssigned = 0;

                    if(stockProducts[productID].inventoryAmount <= 0){
                        for(let j=0;j<stockProducts[productID].piList.length;j++)
                        {
                            stockProducts[productID].piList[j].quantityAssigned = 0;
                        }
                    }

                    else if(stockProducts[productID].quantityOrdered <= stockProducts[productID].inventoryAmount)
                    {
                         
                        for(let j=0;j<stockProducts[productID].piList.length;j++)
                        {
                            stockProducts[productID].piList[j].quantityAssigned = stockProducts[productID].piList[j].quantityOrdered;
                            stockProducts[productID].quantityAssigned += stockProducts[productID].piList[j].quantityAssigned;
                        }
                    }

                    else
                    {

                        for(let j=0;j<stockProducts[productID].piList.length;j++)
                        {
                            stockProducts[productID].piList[j].quantityAssigned = stockProducts[productID].piList[j].quantityOrdered * (stockProducts[productID].inventoryAmount/stockProducts[productID].quantityOrdered);
                            stockProducts[productID].piList[j].quantityAssigned = Math.trunc(stockProducts[productID].piList[j].quantityAssigned);
                            stockProducts[productID].quantityAssigned += stockProducts[productID].piList[j].quantityAssigned;
                        }                        
                    }

                    if((stockProducts[productID].quantityOrdered > stockProducts[productID].quantityAssigned) && (stockProducts[productID].quantityAssigned>0))
                    {
                        var remaining = stockProducts[productID].inventoryAmount - stockProducts[productID].quantityAssigned;
                        let lastIndex = stockProducts[productID].piList.length - 1;

                        var need = stockProducts[productID].piList[lastIndex].quantityOrdered - stockProducts[productID].piList[lastIndex].quantityAssigned;

                        if(remaining > 0)
                        {

                            if(need <= remaining)
                            {
                                stockProducts[productID].piList[lastIndex].quantityAssigned += need;
                                stockProducts[productID].quantityAssigned += need;
                            }
                            else{
                                stockProducts[productID].piList[lastIndex].quantityAssigned += remaining;
                                stockProducts[productID].quantityAssigned += remaining;
                            }
                        }
                    }   
                }


                for(let i=0;i<cart.length;i++)
                {
                    for(let j=0;j<cart[i].products.length;j++)
                    {
                        productID = cart[i].products[j].productID;
                        productID = JSON.stringify(productID);

                        if(stockProducts[JSON.stringify(productID)] !== undefined )
                        {
                            piList = stockProducts[JSON.stringify(productID)].piList;
                            for(let k=0;k<piList.length;k++)
                            {
                                if(cart[i].proformaID == piList[k].proformaID)
                                {
                                    cart[i].products[j].quantityAssigned = piList[k].quantityAssigned;
                                    break;
                                }
                            }
                        }
                    }
                }
                console.log('stock products',stockProducts)

                for(let i=0;i<cart.length;i++)
                {
                    cart[i].batches = [];
                    cart[i].finalProducts = [];

                    for(let j=0;j<cart[i].products.length;j++)
                    {
                        
                        // remove this if statement to reproduce products and batches inventory discrepency
                        if(cart[i].products[j].quantityAssigned > 0)
                        {
                            productID = cart[i].products[j].productID;
                            found = false;

                            for(k=0;k<batchVariant.length;k++)
                            {
                                if(productID == batchVariant[k].productID && batchVariant[k].inventory > 0)
                                {
                                    // batches array for the products in cart
                                    var x = $.extend(true,{},batchVariant[k]);
                                    cart[i].batches.push(x); 

                                    // cart[i].batches.push(batchVariant[k]); 
                                    found = true;
                                }
                            }

                            if(found)
                            {
                                // push only those products that are found in batches
                                cart[i].finalProducts.push(cart[i].products[j]);
                            }
                        }

                    }

                    // delete those products that are not found in batches
                    // delete cart[i].products;
                }


                batches = [];
                var batchesCopy = [];
 
                for(let i=0;i<cart.length;i++)
                {
                    for(let j=0;j<cart[i].batches.length;j++)
                    {
                        cart[i].batches[j].currentInventory = cart[i].batches[j].inventory;
                        cart[i].batches[j].totalQuantityOrdered = 0;

                        batchVariantID = JSON.stringify(cart[i].batches[j].batchVariantID);
                        if(batchesCopy[JSON.stringify(batchVariantID)] == undefined)
                        {
                            batches.push(cart[i].batches[j]);
                            batchesCopy[JSON.stringify(batchVariantID)] = batchVariantID;
                        }
                    }
                }

                let newBatches;

                for(let i=0;i<cart.length;i++)
                {
                    newBatches = [];
                    k=0;
                    for(let j=0;j<cart[i].finalProducts.length;j++)
                    {
                        newBatches[k] = handleCartChangeCopy(batches,batches,cart[i].finalProducts[j].productID,cart[i].finalProducts[j].quantityAssigned);
                        k++;
                    }   

                    // actual batches in use out of all the batches
                    cart[i].finalBatches = newBatches;
                }

                // this code is for making the productList from the final batches

                for(let i=0;i<cart.length;i++)
                {
                    productsList = [];

                    for(let j=0;j<cart[i].finalBatches.length;j++)
                    {
                        a = cart[i].finalBatches[j];

                        for(let k=0;k<a.length;k++)
                        {
                            productsList.push(a[k]);
                        }
                    }
                    cart[i].productsList = productsList;
                }
                

               // this code is for setting the proformaID at the batch level

                for(let i=0;i<cart.length;i++)
                {
                    for(let j=0;j<cart[i].productsList.length;j++)
                    {
                        cart[i].productsList[j].proformaInvoiceID = cart[i].proformaID;
                    }
                }


                // code for calculating missing products

                for(let i=0;i<cart.length;i++)
                {
                    var missingProductsList = [];
                    var prods = cart[i].products;

                    for(let j=0;j<prods.length;j++)
                    {
                        var diff = prods[j].quantityOrdered - prods[j].quantityAssigned;

                        if(diff){

                            var obj = {
                                quantityOrdered: prods[j].quantityOrdered,
                                quantityAssigned: prods[j].quantityAssigned,
                                productName: prods[j].productName,
                                difference: diff,
                                basePrice: prods[j].productBasePrice
                            }

                            missingProductsList.push(obj)
                        }
                    }
                    
                    cart[i].missingProductsList = missingProductsList;
                }

                //

                if(cart.length == 0)
                {
                    return false;
                }

                // this code is for building the chosen orders section

                for(let i=0;i<proformaArray.length;i++)
                {
                    let proformaID = proformaArray[i];

                    for(let j=0; j<outletList.length;j++)
                    {
                        if(proformaID == outletList[j].json.PISummary[0].proformaInvoiceID)
                        {
                            id = outletList[j].json.PISummary[0].proformaInvoiceID;
                            storeName = outletList[j].json.customerInfo[0].firstName;
                            grossBill = outletList[j].json.PISummary[0].grossBill;
                            quantityOrdered = outletList[j].json.PIDetail.length;
                            proformaInvoiceID = outletList[j].json.PISummary[0].proformaInvoiceID;
                            externalOrderID = outletList[j].json.PISummary[0].externalOrderID;

                            // $('#chosenOutletList').append('<div id=chosen-'+id+' onclick="chosenOutletOrder(this)" style="padding:10px; border-bottom:solid 1px #eff1f3"><div style="display:flex; flex-direction:row; align-items:center"><span style="margin-left:10px" class="text_14_500_212b36">'+storeName+'</span></div><div style="display:flex; flex-direction:row; justify-content:space-between;"><span style="margin-left:20px;" class="text_14_500_565656">Total Items : '+quantityOrdered+'</span><span class="text_18_500_212b36">&#8377; '+grossBill+'</span></div></div>');
                            $('#chosenOutletList').append('<div id=chosen-'+id+' onclick="chosenOutletOrder(this)" style="padding:10px; border-bottom:solid 1px #eff1f3"><div style="display:flex; flex-direction:row; align-items:center"><span class="text_14_500_212b36">'+storeName+'</span></div><div><span class="text_14_500_565656">Order No. : '+externalOrderID+'</span></div><div><span class="text_14_500_565656">PI No. : '+proformaInvoiceID+'</span></div></div>');

                            break;
                        }
                    }
                }

                // this code is for making the batches table from the orders

                for(let i=0;i<cart.length;i++)
                {
                    var table = 
                    `<table class="table bulk_action dataTable no-footer" data-row-style="rowStyle" id="table-${cart[i].proformaID}" data-row-attributes="rowAttributes">
                        <thead>
                            <tr>
                                <th data-field = "productName" data-sortable = "false">Product Name</th>
                                <th data-field= "batchVariantName" data-sortable="false">Batch Name</th>
                                <th data-field= "inventory" data-sortable="false">Inventory</th> 
                                <th data-field= "productQuantityOrdered" data-sortable="false">Quantity Ordered</th> 
                                <th data-field = "quantityOrdered" data-sortable = "false" data-formatter="renderQuantity">Assign Quantity</th> 
                                <th data-field = "turPerUnit" data-sortable = "false">TUR</th>
                                <th data-formatter="deleteBatch"></th>
                            </tr>
                        </thead>
                    </table>`;

                    $('#confirmationTables').append(table);
                    
                    let id = '#table-'+cart[i].proformaID;

                    $(id).bootstrapTable({data:cart[i].productsList,
                                                        search:false,
                                                        reinit: true,
                                                        trimOnSearch:false
                    });
                    
                    if(cart[i].productsList.length <=0){
                       $(".no-records-found td").text("No Stock Available to return") 
                    }

                    $(id).css('display','none');
                }

                $('#chosen-'+cart[0].proformaID).css('background','#ddddddab')
                $('#table-'+cart[0].proformaID).css('display','block');

                $('#pendingOrdersSection').css('display','none');
                $('#confirmationSection').css('display','block');

                openNonAllocated();
                console.log(cart)

            }                
            
            async function orderInfoGenerator(cart)
            {
                var statements = [];

                for(let i=0;i<outletList.length;i++)
                {
                    if(cart.proformaID == outletList[i].json.PISummary[0].proformaInvoiceID)
                    {
                        var customerID = outletList[i].json.customerInfo[0].customerID;
                        var childPartyCode = outletList[i].json.PISummary[0].customerPartyCode;
                        var customerInfo = outletList[i].json.customerInfo[0];
                        var salCode = outletList[i].json.PISummary[0].userName;
                        break;
                    }
                }

                var custInfo = [];
                custInfo.push(customerInfo);

                custInfo[0].address = {};
                custInfo[0].address.addressLine1 = custInfo[0].addressLine1;
                custInfo[0].address.addressLine2 = custInfo[0].addressLine2;
                custInfo[0].address.city = custInfo[0].city;
                custInfo[0].address.state = custInfo[0].state;
                custInfo[0].address.country = custInfo[0].country
                custInfo[0].address.pincode = custInfo[0].pincode;

                customerData = custInfo[0]

                var sales = 0;
                var netSale = 0;
                var grossSale = 0;
                var oldGrossSale = 0;
                var totalTaxes = 0;
                var discountValue = 0;

                for(let i=0;i<cart.productList.length;i++)
                {
                    sales += cart.productList[i].itemSales;
                    netSale += cart.productList[i].taxableValue;
                    grossSale += cart.productList[i].productValue;
                    totalTaxes += cart.productList[i].totalTaxValue;
                    discountValue += cart.productList[i].discountValues;
                }

                oldGrossSale = grossSale;
                grossSale = Math.round(grossSale);
                grossSaleRounded = grossSale
                sales = Math.round(sales * 1000)/1000;
                netSale = Math.round(netSale * 1000)/1000;
                totalTaxes = Math.round(totalTaxes * 1000)/1000;
                discountValue = Math.round(discountValue * 1000)/1000;
                totalDiscountPrice = discountValue
                // console.log(sales,netSale,grossSale,totalTaxes,discountValue);

                var d = new Date();
                var date = d.toISOString().slice(0,10);
                var dateCopy = JSON.stringify(d.getFullYear())+JSON.stringify(d.getMonth()+1)+JSON.stringify(d.getDate());
                
                var counter = localStorage.getItem('lastOrder');
                counter = parseInt(counter,10) + 1;

                localStorage.setItem('lastOrder',counter);


                orderID = 'OR1'+loginResponse.storeList[0].storeID+deviceID+dateCopy+'-'+counter;
                var isError = '';
                var errorMessage = '';
                orderTime = date + ' ' + new Date().toLocaleTimeString();
                var orderType = 'MARKET_ORDER';
                var posDate = date;
                var batchID = '';
                rounding =  grossSale - oldGrossSale;
                rounding = Math.round(rounding * 100)/100;
                var paymentStatus = 'PAID';
                var billingUsername = userName;
                var Status = 'ORST_DELIVERED';
                var totalItems = cart.productList.length;

                // new code 

                totalCashDiscount = 0
                var allDiscountsArray = []

                for(let i=0;i<cart.productList.length;i++)
                {
                    cart.productList[i].productID = parseInt(cart.productList[i].productID);
                    cart.productList[i].additionalCharges = [];
                    cart.productList[i].orderTimeLocal = orderTime;
                    cart.productList[i].voidRemarks = '';
                    delete cart.productList[i].status;
                    cart.productList[i].Status = Status;
                    cart.productList[i].isNoCharge = 0;
                    cart.productList[i].additionalChargeValues = 0;
                    cart.productList[i].voucherID = 0;
                    cart.productList[i].orderSubID = i+1;
                    cart.productList[i].timezone = 'Asia/Kolkata';

                    var discArr = cart.productList[i].discounts;
                    allDiscountsArray.push(...discArr)

                    discArr.map(n=>{
                        if(n.isCashDiscount == 1){
                        totalCashDiscount += n.discountPrice
                        }
                    })

                }

                totalCashDiscount = parseFloat(totalCashDiscount.toFixed(3))
                var allAppliedDisounts = [];

                discountDetails.map(a=>{
                    var discTotal = 0
                    var sDisc = []
                    var obj;
                    sDisc = allDiscountsArray.filter(b=>b.discountID == a.discountID)
                    sDisc.map(c=>{
                    discTotal += c.discountPrice
                    discTotal = parseFloat(discTotal.toFixed(3))
                    obj = {...c,'discountPrice':discTotal}
                    })
                    if(obj){
                    allAppliedDisounts.push(obj)
                    }
                })

                // console.log(allAppliedDisounts,'allAppliedDisounts')

                // ends here

                for(let i=0;i<cart.paymentList.length;i++)
                {
                    cart.paymentList[i].posDate = posDate;
                    cart.paymentList[i].orderTimeLocal = orderTime;
                }

                var paymentList = cart.paymentList;
                pdfTableData = cart.productList;

                creditNotesDetailsForPDF = []

                paymentList.map(m=>{
                    if(m.paymentType=="PAYMENT_CREDIT_NOTE"){
                        creditNotesDetailsForPDF.push(m.amount)
                    }
                })

                // console.log(paymentList,'paymentList')


                creditNotesDetailsForPDF.sort((a,b)=>b-a)

                var orderInformation = {
                    chainID:1,
                    orderID,
                    currency:'INR',
                    currencyCode:"INR",
                    customers:custInfo,
                    timezone:'Asia/Kolkata',
                    userName,
                    deviceID,
                    netBill:netSale,
                    mocID:mocs.mocID,
                    sales,
                    paymentStatus:"PAID",
                    orderType:"MARKET_ORDER",
                    deliveryStatus:"DELIVERED",
                    PINumber:cart.proformaID,
                    partyCode:childPartyCode,
                    salCode,
                    isOrderRounded:1,
                    billingUsername:userName,
                    loyaltyID:-1,
                    loyaltyPointsRedeemed:0,
                    posDate:date,
                    batchID:'',
                    invoiceNumber:"",
                    discountValue,
                    discounts:allAppliedDisounts,
                    totalCashDiscount,
                    isOpenBill:0,
                    openBill:[],
                    additionalCharges:[],
                    totalProductLevelAdditionalCharges:0,
                    totalChargeValue:0,
                    isNoCharge:0,
                    rounding,
                    grossBill:grossSale,
                    paymentList,
                    refundPayments:[],  
                    customerIDs:customerID,
                    orderCreationTimeLocal:date,
                    cashTendered:0,
                    changeAmount:0,
                    orderRemarks:"",
                    numReceiptPrints:1,
                    Status:"ORST_DELIVERED",
                    productsList:cart.productList,
                    billSettledTimeLocal:orderTime,
                    taxes:totalTaxes,
                    sourceID : loginResponse.storeList[0].storeID,
                    totalItems,
                    isSync : 0,
                    voucherID : -1,
                    requestType: 'ORDER'
                }
                
                var updatedOrderInformation = Object.assign({},orderInformation);
                updatedOrderInformation.requestType = 'UPDATE_ORDER'
                console.log('orderInformation',orderInformation)
                console.log('updatedOrderInformation',updatedOrderInformation)

                orderInformation = JSON.stringify(orderInformation);
                updatedOrderInformation = JSON.stringify(updatedOrderInformation);
                customerInfo = JSON.stringify(customerInfo);

                var query = `INSERT INTO orderInformation (orderID,customerID,customerInfo,childPartyCode,isError,errorMessage,orderTime,orderType,posDate,batchID,netSale,sales,discountValue,grossSale,totalTaxes,rounding,paymentStatus,userName,billingUsername,Status,totalItems,orderInformation) VALUES `
                    +
                `('${orderID}',${customerID},'${customerInfo}','${childPartyCode}','${isError}','${errorMessage}','${orderTime}','${orderType}','${posDate}','${batchID}','${netSale}','${sales}','${discountValue}','${grossSale}','${totalTaxes}','${rounding}','${paymentStatus}','${userName}','${billingUsername}','${Status}','${totalItems}','${orderInformation}')`;

                statements.push(query);

                query = `INSERT INTO updatedOrderInformation (orderID,customerID,customerInfo,childPartyCode,isError,orderTime,orderType,posDate,batchID,netSale,sales,discountValue,grossSale,totalTaxes,rounding,paymentStatus,userName,billingUsername,Status,totalItems,orderInformation) VALUES `
                    +
                `('${orderID}',${customerID},'${customerInfo}','${childPartyCode}','${isError}','${orderTime}','${orderType}','${posDate}','${batchID}','${netSale}','${sales}','${discountValue}','${grossSale}','${totalTaxes}','${rounding}','${paymentStatus}','${userName}','${billingUsername}','${Status}','${totalItems}','${updatedOrderInformation}')`;
                  
                statements.push(query);

                var currentInventory,quantityOrderedCost,batchVariantID,productID,quantityAssigned,quantityOrdered;
                var proformaID = cart.proformaID;

                // updation of batches

                for(let i=0;i<cart.productList.length;i++)
                {

                    batchVariantID = cart.productList[i].batchVariantID;
                    quantityOrdered = cart.productList[i].quantityOrdered;
                    quantityOrderedCost = cart.productList[i].quantityOrderedCost;

                    statements.push(`UPDATE batchProductVariants SET inventory = inventory - ${quantityOrdered}, inventoryCost = inventoryCost - ${quantityOrderedCost} WHERE batchVariantID = ${batchVariantID}`);
                }

                // insertion into orderPayments

                for(let i=0;i<cart.paymentList.length;i++)
                {
        
                    paymentType = cart.paymentList[i].paymentType;
                    amount = cart.paymentList[i].amount;
                    paymentSubID = cart.paymentList[i].paymentSubID;

                    statements.push(`INSERT INTO OrderPayments (orderID,customerID,childPartyCode,paymentSubID,posDate,paymentType,orderTime,amount) VALUES `+
                    `('${orderID}',${customerID},'${childPartyCode}',${paymentSubID},'${posDate}','${paymentType}','${orderTime}','${amount}')`)
                }

                // updation of credit notes

                for(let i=0;i<cart.paymentList.length;i++)
                {
                    if(cart.paymentList[i].paymentType == "PAYMENT_CREDIT_NOTE")
                    {
                        statements.push(`UPDATE creditNotes SET isActive = 0 WHERE creditNoteID = '${cart.paymentList[i].creditNoteID}'`)
                    }
                } 

                // updation of piSummary 

                statements.push(`UPDATE piSummary SET status = 'COMPLETED' WHERE proformaInvoiceID = '${proformaID}'`)
                
                // console.log(statements)
                
                await new Promise((resolve,reject)=>{
                    
                    db.runBatchAsync(statements)
                    .then((result)=>{
                        resolve();
                    })
                    .catch((error)=>{
                        console.log(error)
                    })
                })

                console.log(orderID,'inserted')  
            }

            function handleCartChangeCopy(sProdData,cData,productID,currentValue)
            { 

                var filteredCartData = sProdData.filter(m=>(m.productID==productID && m.currentInventory>0))

                // console.log(productID , filteredCartData, currentValue)

                if(currentValue == 0){

                    return [];
                }
                
				filteredCartData.sort(function(a,b){
					return new Date(a.manufacturingDate) - new Date(b.manufacturingDate);
                });

				var maxUnitLimit = currentValue;
				filteredCartData.map(m=>{

                    if(maxUnitLimit == 0){
                        return;
                    }

					if(maxUnitLimit>m.currentInventory){

                        m['quantityOrdered'] = m.currentInventory;
                        m['totalQuantityOrdered'] += m.currentInventory;
                        maxUnitLimit = maxUnitLimit-m.currentInventory;
                        m['currentInventory'] = 0;
                        m['productQuantityOrdered'] = currentValue;
					}
					else{
                        
                        m['quantityOrdered'] = maxUnitLimit;
						m['totalQuantityOrdered'] += maxUnitLimit;
						m['currentInventory'] = m.currentInventory - maxUnitLimit;
                        maxUnitLimit=0;
                        m['productQuantityOrdered'] = currentValue;
					}

				})
				
                let k=0;
                let temp = [];

                for(let i=0;i<filteredCartData.length;i++)
                {
                    m = filteredCartData[i];

                    if(m.quantityOrdered>0){
                        
                       temp[k] = {
                            batchVariantID:m.batchVariantID,
                            batchVariantName:m.batchVariantName,
                            // quantityAssigned:m.quantityOrdered,
                            quantityOrdered: m.quantityOrdered,
                            productID:m.productID,
                            inventory:m.inventory,
                            currentInventory:m.currentInventory,
                            taxArr:m.taxArr,
                            taxes:m.taxes,
                            // turPerUnit: Math.round(m.turPerUnit * 1000)/1000,
                            turPerUnit: m.turPerUnit,
                            inventoryCost: m.inventoryCost,
                            quantityOrderedCost: Math.round(m.turPerUnit * m.quantityOrdered * 1000)/1000,
                            sbomDesc: m.sbomDesc,
                            productName : m.productName,
                            productQuantityOrdered : m.productQuantityOrdered
                        };

                        k++;                         
                    }
                }

                return temp;

            }

            function openNonAllocated(){

                $('#basepackTwo').empty();
 
                var show = false;
                nonAllocatedDataArray = []

                console.log(cart,'cart')

                for(let i=0;i<cart.length;i++)
                {
                    var missingProductsList = cart[i].missingProductsList;
                    var firstName = cart[i].firstName;
                    var orderID = cart[i].externalOrderID
                    var showHeader = false;

                    for(let i=0;i<missingProductsList.length;i++)
                    {
                        if(missingProductsList[i].difference){
                            showHeader  = true;
                        }
                    }

                    if(showHeader){
                        $('#basepackTwo').append(`<div class="flex-row" style="height:60px; padding-left:10px; border-radius:4px; background-color:#979797">
                                    <div style="flex:3"><span class="text_16_500_212b36">${firstName}</span></div>
                                    </div>`)

                        
                        $('#basepackTwo').append(`<div class="flex-row" style="padding-left:20px; height:60px;">
                                <div style="flex:3"><span class="text_16_500_212b36">Product Name</span></div>
                                <div style="flex:1;"><span class="text_16_500_212b36">Quantity Ordered</span></div>
                                <div style="flex:1;"><span class="text_16_500_212b36">Non Allocated</span></div>
                            </div>`);
                    }

                    for(let i=0;i<missingProductsList.length;i++)
                    {
                        if(missingProductsList[i].difference){
                            show  = true;
                        }
                        
                        $('#basepackTwo').append(nonAllocatedGeneratorTwo(missingProductsList[i]));
                    }

                    getPdfData(missingProductsList,firstName,orderID)
                }
                
                if(show){
                    $('#basepackModalTwo').modal('show');
                }
            }

            function nonAllocatedGeneratorTwo(product){

                if(product.difference)
                {
                    return  `<div class="flex-row" style="padding-left:20px; height:60px;">
                                <div style="flex:3"><span class="text_14_500_565656">${product.productName}</span></div>
                                <div style="flex:1;"><span class="text_14_500_565656">${product.quantityOrdered}</span></div>
                                <div style="flex:1;"><span class="text_14_500_565656">${product.difference}</span></div>
                            </div>`
                } 
            }
            
            getPdfData=(missingProductsList,firstName,orderID)=>{

                var rowsData =missingProductsList

                rowsData.map((n,i)=>{
                    n['SNo'] = i+1;
                })

                var textObj = 
                {
                    'title' : firstName,
                    'orderID' : orderID
                }
                var fontSize = 20;

                var tableData = {
                    'headersArray' : ["Product Name", "Difference"],
                    'rowData':rowsData,
                    'tableXPos':15,
                    'tableYPos':30,
                    'tableFontSize':12,
                    'headerWidth' : 150,
                }

                var fileName = "nonAllocatedBasepack.pdf"

                getAllTableData(tableData,textObj,fontSize,fileName)

            }

            getAllTableData=(tableData,textObj,fontSize,fileName)=>{
               dataObj ={
                'tableData':tableData,
                'textObj':textObj,
                'fontSize':fontSize,
                'fileName':fileName,
               }
               nonAllocatedDataArray.push(dataObj)
            }

            getTitle=(doc,docInfo)=>{
                doc.setTextColor('#f00')
                doc.setFont("courier");
                doc.setFontStyle("bold");
                var xOffsetCenter = ((doc.internal.pageSize.width)-15 )/2
                doc.text(`${docInfo.title}`,xOffsetCenter,15,null,null,'center')
            }

            getStoreDetails=async(doc)=>{
                var storeData = await new Promise((resolve,reject)=>{    
                db.get(`SELECT * FROM listStores where storeID = ${storeID}`,function(err,data){
                    if(err){
                        console.log(err)
                    }
                    else{
                        resolve(data);
                    }
                })
                })

                doc.setTextColor('#000')
                doc.setFont("helvetica");
                doc.setFontStyle("normal");

                doc.text( `${storeData.storeName} `, 15, 25);
                doc.text( `${storeData.outletAddLine1} `, 15, 29);
                doc.text( `${storeData.outletAddLine2} `, 15, 33);
                doc.text( `${storeData.outletAddCity} `, 15, 37);
                doc.text( `Contact No : ${storeData.outletPhone} `, 15, 41);
                doc.text( `GSTIN: ${storeData.gstNumber} `, 15, 45);
            }

            async function triggerPrintPdfTwo (){

                console.log(nonAllocatedDataArray,'nonAllocatedDataArray')

                const doc = new jsPDF();
                var xOffset = (doc.internal.pageSize.width)-15;

                var tablecolumns = [
                    {title: "#", dataKey: "SNo"},
                    {title: "Item Name", dataKey: "productName"}, 
                    {title: "Quantity Ordered", dataKey: "quantityOrdered"},
                    {title: "Quantity Assigned", dataKey: "quantityAssigned"},
                    {title: "Non Allocated", dataKey: "difference"},
                ];


                doc.setFontSize(10);
                doc.setFontStyle("normal");

                var docInfo = {
                    'title' : 'Non Allocated Basepack',
                    'storeInfoShown' :true,
                    'fileName' : "nonAllocatedBasepack.pdf"
                }

                getTitle(doc,docInfo)

                await getStoreDetails(doc)
                var tableCounter = 0
                nonAllocatedDataArray.map((m)=>{
                    if(m.tableData.rowData && m.tableData.rowData.length){
                        var tableOneEndPos = doc.autoTable.previous.finalY;
                        var tableStart = 10
                        if(!tableCounter){
                            tableStart = 47
                        }
                        if(tableOneEndPos){
                            tableStart = 10 + tableOneEndPos
                        }
    
                        doc.text(`Outlet Name : ${ m.textObj.title}`, xOffset,tableStart+15,null, null, 'right');
                        doc.text( `Order No. : ${ m.textObj.orderID} `, xOffset,tableStart+20, null, null, 'right');
    
                        doc.autoTable(tablecolumns, m.tableData.rowData, {
                            startY: tableStart+25,
                            theme: 'grid',  
                            tableWidth: 'auto', 
                            columnWidth: 'wrap', 
                            showHeader: 'everyPage',
                            tableLineColor: 200, 
                            tableLineWidth: 0,
                            margin: { horizontal: 15 },
                            headerStyles: {theme: 'grid'},
                            styles: { overflow: "linebreak",fontSize:'8',},
                            headerStyles:{fillColor: '#c7c7c7',textColor:'#000'},
                            bodyStyles: { valign: "top" },
                            theme: "grid"
                        });

                        tableCounter++;
                    }
               
                })

                // doc.save(docInfo.fileName);
                var pdfStr =doc.output('datauristring');

                var docObj = {
                    'docStr' : pdfStr,
                    'name' : docInfo.fileName
                }
                docObj['locationFolder'] = `SSPDF`
                ipc.send('print',docObj)
                doc.save(docInfo.fileName, {returnPromise:true}).then(()=>showSuccessModal('download',true,docInfo.fileName))
            }

            showSuccessModal=(action,status,fileName)=>{
                if(status){
                    if(action == 'print'){
                    $('#successTag').text('Print')
                    $('#successTagl').text('printed')
                    $('#fileLocation').text('')
                    $('.fileName').text(fileName)
                    //$('#successModal').modal('show');
                    }
                    else if(action == 'download'){
                    $('#successTag').text('Download')
                    $('#successTagl').text('downloaded')
                    $('#fileLocation').text(`File Location: SSApp/resources/SSPDF/${fileName}`)
                    $('.fileName').text(fileName)
                    }
                    $('#successModal').modal('show');
                }
            }

            sqlite3.Database.prototype.runAsync = function (sql, ...params) {
                return new Promise((resolve, reject) => {
                    this.run(sql, params, function (err) {
                        if (err) return reject(err);
                        resolve(this);
                    });
                });
            };

            sqlite3.Database.prototype.runBatchAsync = function (statements) {
                var results = [];
                var batch = ['BEGIN', ...statements, 'COMMIT'];
                console.log(batch);
                return batch.reduce((chain, statement) => chain.then(result => {
                    results.push(result);
                    return db.runAsync(...[].concat(statement));
                }), Promise.resolve())
                .catch(err => db.runAsync('ROLLBACK').then(() => Promise.reject(err +
                    ' in statement #' + results.length)))
                .then(() => results.slice(2));
            };


            triggerPrintPdf = (action) => {
                $(`#generateBill`).modal('hide');
                noPrint = false
                var currentTimestamp = moment().format("YYYYMMDDHHmmss")
                var table1columns = [
                    {title: "#", dataKey: "SNo"},
                    {title: "Item Name", dataKey: "productName"}, 
                    {title: "Quantity", dataKey: "quantityOrdered"},
                    {title: "Base Price", dataKey: "productBasePrice"},
                    {title: "MRP", dataKey: "MRP"},
                    {title: "Discount", dataKey: "discountValues"},
                    {title: "CGST", dataKey: "CGST"},
                    {title: "SGST", dataKey: "SGST"},
                    {title: "Net Amount", dataKey: "productValue"},
                    // {title: "Total", dataKey: "totalPrice"}, 
                ];
                
                var table2columns = [
                    {title: "GST Tax", dataKey: "nameOnBill"},
                    {title: "Taxable Amt", dataKey: "taxalbleAmt"}, 
                    {title: "Tax Value", dataKey: "taxValue"},
                ];
                
                var columnsObj ={
                    table1columns,
                    table2columns
                }

                var tableData = pdfTableData

                tableData.sort((a,b)=>(a.productID) - (b.productID))

                tableData.map((m,i)=>{
                    m['SNo'] = i+1
                })

                var billInfo={
                    'billNo':orderID,
                    'billTime':orderTime,
                }

                var creditNotesInfo={
                    'creditNotesAdjust':creditNotesAdjust,
                    'payableAmnt':payableAmnt,
                    'creditNotesDetails' : creditNotesDetailsForPDF
                }

                var cashDiscountInfo={
                    'cashDiscount':totalCashDiscount,
                    'cashDiscPercent':cashDiscPercent,
                }

                var orderInfo={
                    'totalPrice' : grossSaleRounded,
                    'discountValue': totalDiscountPrice,
                    'totalItems' : tableData.length,
                    'rounding' : rounding,
                }

                if(creditNotesDetailsForPDF.length){
                    orderInfo['creditNotesInfo'] = creditNotesInfo
                }

                if(totalCashDiscount){
                    orderInfo['cashDiscountInfo'] = cashDiscountInfo
                }

                var docInfo = {
                    'action': action,
                    'title' : 'Tax invoice',
                    'storeInfoShown' :true,
                    'billInfo':billInfo,
                    'retailerInfo' :customerData,
                    'orderInfo' : orderInfo,
                    'taxShown': true,
                    'fileName' : `${orderID}_${currentTimestamp}.pdf`
                }
            
                printPdf(columnsObj,tableData,docInfo) 
            };
            
            $("#successModal").on("hidden.bs.modal", function () {
                window.location.href= reRenderLocation
            });

            $("#generateBill").on("hidden.bs.modal", function () {
                if(noPrint){
                    window.location.href= reRenderLocation
                }
            })

        </script>

    </body>
</html>